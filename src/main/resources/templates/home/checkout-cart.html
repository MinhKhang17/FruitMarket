<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Thanh toán — Fruit Market</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

    <!-- CSRF (nếu app có sẵn ở layout thì có thể bỏ) -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        :root { --green:#198754; --green-dark:#156a3c; --muted:#6c757d; --card-bg:#fff; --page-bg:#f6faf6; }
        body { background: var(--page-bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
        .card { max-width: 980px; margin: 32px auto; border-radius: 12px; }
        .thumb { width:70px; height:70px; object-fit:cover; border-radius:8px; }
        .price { font-weight:600; color:var(--green); }
        .small-muted { color:#95a49a; font-size:.9rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/notification :: notification}"></div>

<div class="container">
    <div class="card shadow-sm p-4">
        <h4 class="mb-4"><i class="bi bi-basket2-fill text-success"></i> Xác nhận đơn hàng (Giỏ hàng)</h4>

        <!-- ========== DANH SÁCH ITEM ========== -->
        <div class="mb-3">
            <!-- Nếu có selectedItems (chọn một phần giỏ) -->
            <div th:if="${selectedItems != null}">
                <div th:each="item : ${selectedItems}" class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}"
                         class="thumb" onerror="this.src='/images/placeholder.png'"/>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" th:text="${item.name ?: 'Sản phẩm'}">Sản phẩm</div>
                        <small class="text-muted" th:if="${item.variantName != null}">
                            Biến thể: <span th:text="${item.variantName}">V</span>
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1"
                             th:text="${#numbers.formatDecimal(item.price ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>

                        <div class="muted small">
                            <span th:if="${item.unit != null and item.unit.toUpperCase() == 'KILOGRAM'}">
                                Khối lượng: <span th:text="${item.weight ?: 0.1}">0.1</span> kg
                            </span>
                            <span th:unless="${item.unit != null and item.unit.toUpperCase() == 'KILOGRAM'}">
                                Số lượng: <span th:text="${item.quantity ?: 1}">1</span>
                            </span>
                        </div>

                        <div class="fw-bold mt-1"
                             th:text="${#numbers.formatDecimal((item.subTotal ?: (item.price ?: 0) * (item.quantity ?: 0)), 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
                    </div>
                </div>
            </div>

            <!-- Mặc định: hiển thị toàn bộ giỏ -->
            <div th:if="${selectedItems == null}">
                <div th:each="item : ${cart.items}" class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}"
                         class="thumb" onerror="this.src='/images/placeholder.png'"/>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" th:text="${item.name ?: 'Sản phẩm'}">Sản phẩm</div>
                        <small class="text-muted" th:if="${item.variantName != null}">
                            Biến thể: <span th:text="${item.variantName}">V</span>
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1"
                             th:text="${#numbers.formatDecimal(item.price ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>

                        <div class="muted small">
                            <span th:if="${item.unit != null and item.unit.toUpperCase() == 'KILOGRAM'}">
                                Khối lượng: <span th:text="${item.weight ?: 0.1}">0.1</span> kg
                            </span>
                            <span th:unless="${item.unit != null and item.unit.toUpperCase() == 'KILOGRAM'}">
                                Số lượng: <span th:text="${item.quantity ?: 1}">1</span>
                            </span>
                        </div>

                        <div class="fw-bold mt-1"
                             th:text="${#numbers.formatDecimal((item.subTotal ?: (item.price ?: 0) * (item.quantity ?: 0)), 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TÓM TẮT + ĐỊA CHỈ + THANH TOÁN ========== -->
        <div class="row mt-3">
            <!-- Địa chỉ -->
            <div class="col-md-6">
                <div class="mb-3">
                    <h6>Địa chỉ giao hàng</h6>

                    <!-- Có địa chỉ -->
                    <div th:if="${userDetail != null and !#lists.isEmpty(userDetail)}">
                        <p class="text-muted">Chọn địa chỉ có sẵn hoặc thêm mới nếu cần.</p>

                        <div class="list-group mb-3">
                            <label th:each="addr, i : ${userDetail}"
                                   class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <input class="form-check-input me-2 address-radio" type="radio" name="addressSelect"
                                           th:id="${'addr_'+i.index}" th:value="${addr.id}"
                                           th:checked="${i.index == 0}" onchange="selectExistingAddress(this)">
                                    <strong th:text="${addr.phone}">0123456789</strong>
                                    <div class="small text-muted" th:text="${addr.address}">Địa chỉ</div>
                                    <div class="small" th:if="${addr.receiverName != null}">
                                        Người nhận: <span th:text="${addr.receiverName}">Tên</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleNewAddressForm()">
                                <i class="bi bi-plus-circle"></i> Thêm địa chỉ mới
                            </button>
                        </div>

                        <!-- Form thêm mới (dropdown tỉnh/ huyện/ phường) -->
                        <form id="newAddressFormGeo" class="mt-3 d-none" th:action="@{/cart/checkout/save-address}" method="post">
                            <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />

                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành</label>
                                    <select id="na_province" class="form-select" required>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select id="na_district" class="form-select" required disabled>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select id="na_ward" class="form-select" required disabled>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-md-8">
                                    <label class="form-label">Địa chỉ cụ thể</label>
                                    <input type="text" class="form-control" name="address" placeholder="Số nhà, đường..." required />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" name="phone" placeholder="Nhập số điện thoại..." required />
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Tên người nhận</label>
                                    <input type="text" class="form-control" name="receiverName" placeholder="Ví dụ: Nguyễn Văn A"/>
                                    <div class="form-text">Để trống sẽ dùng tên đăng nhập.</div>
                                </div>
                            </div>

                            <!-- Hidden GHN -->
                            <input type="hidden" name="provinceId" id="na_provinceId"/>
                            <input type="hidden" name="districtId" id="na_districtId"/>
                            <input type="hidden" name="wardCode"   id="na_wardCode"/>

                            <div class="text-end mt-3">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check2-circle"></i> Lưu địa chỉ mới
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleNewAddressForm()">
                                    Hủy
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Không có địa chỉ -->
                    <div th:if="${userDetail == null or #lists.isEmpty(userDetail)}">
                        <div class="alert alert-warning py-2 mb-3">Bạn chưa có địa chỉ giao hàng. Vui lòng thêm địa chỉ.</div>

                        <form th:action="@{/cart/checkout/save-address}" method="post" class="mb-0">
                            <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />

                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành</label>
                                    <select id="ka_province" class="form-select" required>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select id="ka_district" class="form-select" required disabled>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select id="ka_ward" class="form-select" required disabled>
                                        <option value="">-- Chọn --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3 mt-2">
                                <label class="form-label">Địa chỉ cụ thể</label>
                                <input type="text" class="form-control" name="address" placeholder="Số nhà, đường..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="text" class="form-control" name="phone" placeholder="Nhập số điện thoại..." required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tên người nhận</label>
                                <input type="text" class="form-control" name="receiverName" placeholder="Ví dụ: Nguyễn Văn A"/>
                                <div class="form-text">Để trống sẽ dùng tên đăng nhập.</div>
                            </div>

                            <input type="hidden" name="provinceId" id="ka_provinceId"/>
                            <input type="hidden" name="districtId" id="ka_districtId"/>
                            <input type="hidden" name="wardCode"   id="ka_wardCode"/>

                            <button type="submit" class="btn btn-success w-100">Lưu địa chỉ và tiếp tục</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Hộp tổng kết + GHN + Thanh toán -->
            <div class="col-md-6">
                <div class="p-3 bg-white rounded shadow-sm">
                    <div class="d-flex justify-content-between mb-2">
                        <div>Tổng số lượng:</div>
                        <div th:text="${totalQuantity ?: 0}">0</div>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <div>Tổng tiền hàng:</div>
                        <div id="goodsTotal" class="fs-6"
                             th:text="${#numbers.formatDecimal(totalPrice ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
                    </div>

                    <div class="d-flex justify-content-between mb-1">
                        <div>Phí vận chuyển (GHN):</div>
                        <div id="shipFee" class="price">—</div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <div class="fw-semibold">Tổng thanh toán:</div>
                        <div id="grandTotal" class="price">—</div>
                    </div>
                    <div class="small-muted">Phí sẽ được tính khi bạn chọn/đổi địa chỉ.</div>

                    <!-- Form checkout -->
                    <form th:action="@{/cart/process-checkout-from-page}" method="post" onsubmit="return finalizeCartCheckout(this);">
                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                        <input type="hidden" id="finalAddressId" name="addressId" value="" />
                        <input type="hidden" id="toDistrictId"   name="toDistrictId" value="">
                        <input type="hidden" id="toWardCode"     name="toWardCode"   value="">
                        <input type="hidden" id="finalShipFee"   name="shippingFee"  value="0"/>
                        <input type="hidden" id="finalServiceId" name="serviceId"    value=""/>

                        <h6>Phương thức thanh toán</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                            <label class="form-check-label" for="cod">Thanh toán khi nhận hàng</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="VNPAY">
                            <label class="form-check-label" for="bank">VNPAY</label>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <a th:href="@{/cart}" class="btn btn-outline-secondary">Quay lại giỏ hàng</a>
                            <button type="submit" class="btn btn-success">Xác nhận đặt hàng</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // CSRF
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content || null;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || "X-CSRF-TOKEN";

    // Tổng tiền từ server (an toàn null)
    const GOODS_TOTAL_NUMBER = Number(/*[[${totalPrice}]]*/ 0) || 0;
    const TOTAL_QUANTITY     = Number(/*[[${totalQuantity}]]*/ 1) || 1;
    const TOTAL_WEIGHT       = Number(/*[[${totalWeight}]]*/ 0) || 0;

    // Elements
    const shipFeeEl      = document.getElementById("shipFee");
    const grandTotalEl   = document.getElementById("grandTotal");
    const finalShipFee   = document.getElementById("finalShipFee");
    const finalServiceId = document.getElementById("finalServiceId");
    const finalAddressId = document.getElementById("finalAddressId");

    const hidToDistrict  = document.getElementById('toDistrictId');
    const hidToWard      = document.getElementById('toWardCode');

    let lastShip = 0;

    function fmt(n){ try{ return Number(n).toLocaleString("vi-VN")+" ₫"; }catch(_){ return n; } }

    function updateGrand(){
        const grand = GOODS_TOTAL_NUMBER + (lastShip || 0);
        shipFeeEl.textContent    = lastShip > 0 ? fmt(lastShip) : "—";
        grandTotalEl.textContent = fmt(grand);
    }

    async function fetchJsonSafe(input, init){
        const res = await fetch(input, init);
        let data = null;
        try{ data = await res.json(); }catch(_){}
        if(!res.ok){
            const msg = (data && (data.error||data.message)) || `HTTP ${res.status}`;
            throw new Error(msg);
        }
        return data ?? {};
    }
    function debounce(fn, delay=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

    // ===== Đồng bộ tham số giữa UI & Server =====
    const buildCommonPayload = () => ({
        qty: Math.max(1, TOTAL_QUANTITY),
        weight: (TOTAL_WEIGHT > 0 ? TOTAL_WEIGHT : 200),
        length: 20,
        width: 15,
        height: 10,
        insuranceValue: GOODS_TOTAL_NUMBER
    });
    async function postQuote(payload){
        const headers = { "Content-Type":"application/json" };
        if (CSRF_TOKEN) headers[CSRF_HEADER] = CSRF_TOKEN;
        return await fetchJsonSafe('/api/shipping/quote', { method:'POST', headers, body: JSON.stringify(payload) });
    }

    // Tính phí ship theo địa chỉ có sẵn (radio)
    const quoteExisting = debounce(async function(addressId){
        if(!addressId){
            lastShip=0; finalShipFee.value="0"; updateGrand(); return;
        }
        shipFeeEl.textContent = "đang tính...";
        try{
            const data = await postQuote({ addressId, ...buildCommonPayload() });
            const fee = Number(
                (data && (data.fee ?? data.data?.fee)) || 0
            );
            const svc = (data && (data.serviceId ?? data.data?.serviceId)) || "";
            lastShip = fee;
            finalShipFee.value   = String(fee);
            finalServiceId.value = String(svc);
        }catch(e){
            console.error("quoteExisting:", e.message);
            lastShip=0; finalShipFee.value="0";
            shipFeeEl.textContent = "không tính được";
        }
        updateGrand();
    }, 300);

    // Tính phí ship theo địa chỉ mới (dropdown)
    const quoteShipping = debounce(async function(toDistrictId, toWardCode){
        if(!toDistrictId || !toWardCode){
            lastShip=0; finalShipFee.value="0"; updateGrand(); return;
        }
        shipFeeEl.textContent = "đang tính...";
        try{
            const data = await postQuote({
                toDistrictId: Number(toDistrictId),
                toWardCode: String(toWardCode),
                ...buildCommonPayload()
            });
            const fee = Number(
                (data && (data.fee ?? data.data?.fee)) || 0
            );
            const svc = (data && (data.serviceId ?? data.data?.serviceId)) || "";
            lastShip = fee;
            finalShipFee.value   = String(fee);
            finalServiceId.value = String(svc);
        }catch(e){
            console.error("quoteShipping:", e.message);
            lastShip=0; finalShipFee.value="0";
            shipFeeEl.textContent = "không tính được";
        }
        updateGrand();
    }, 300);

    // Radio địa chỉ có sẵn
    function selectExistingAddress(radio){
        if (!radio) return;
        document.getElementById("newAddressFormGeo")?.classList.add("d-none");
        finalAddressId.value = radio.value;
        quoteExisting(radio.value);
    }
    function toggleNewAddressForm(){
        document.getElementById("newAddressFormGeo")?.classList.toggle("d-none");
    }

    // Geo helpers
    async function fetchJson(url){
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
    }
    async function loadProvinces(sel){
        const d = await fetchJson('/api/geo/provinces');
        sel.innerHTML = '<option value="">-- Chọn --</option>';
        d.forEach(p => { const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
        sel.disabled = false;
    }
    async function loadDistricts(pid, sel){
        sel.innerHTML = '<option value="">-- Chọn --</option>';
        if(!pid){ sel.disabled = true; return; }
        const d = await fetchJson(`/api/geo/districts?provinceId=${pid}`);
        d.forEach(x => { const o=document.createElement('option'); o.value=x.id; o.textContent=x.name; sel.appendChild(o); });
        sel.disabled = false;
    }
    async function loadWards(did, sel){
        sel.innerHTML = '<option value="">-- Chọn --</option>';
        if(!did){ sel.disabled = true; return; }
        const d = await fetchJson(`/api/geo/wards?districtId=${did}`);
        d.forEach(x => { const o=document.createElement('option'); o.value=x.id; o.textContent=x.name; sel.appendChild(o); });
        sel.disabled = false;
    }

    function wireGeoForm(prefix){
        const selP = document.getElementById(`${prefix}_province`);
        const selD = document.getElementById(`${prefix}_district`);
        const selW = document.getElementById(`${prefix}_ward`);
        const hidP = document.getElementById(`${prefix}_provinceId`);
        const hidD = document.getElementById(`${prefix}_districtId`);
        const hidW = document.getElementById(`${prefix}_wardCode`);
        if(!selP || !selD || !selW) return;

        loadProvinces(selP).catch(console.error);

        selP.addEventListener('change', async ()=>{
            if(hidP) hidP.value = selP.value || '';
            await loadDistricts(selP.value, selD);
            selW.innerHTML = '<option value="">-- Chọn --</option>';
            selW.disabled  = true;
            if(hidD) hidD.value = '';
            if(hidW) hidW.value = '';
            lastShip=0; finalShipFee.value="0"; updateGrand();
        });

        selD.addEventListener('change', async ()=>{
            if(hidD) hidD.value = selD.value || '';
            await loadWards(selD.value, selW);
            if(hidW) hidW.value = '';
            lastShip=0; finalShipFee.value="0"; updateGrand();
        });

        selW.addEventListener('change', ()=>{
            if(hidW) hidW.value = selW.value || '';
            hidToDistrict.value = selD.value || '';
            hidToWard.value     = selW.value || '';
            quoteShipping(hidToDistrict.value, hidToWard.value);
        });
    }

    function finalizeCartCheckout(form){
        const addr = finalAddressId.value;
        if (!addr){
            alert("Vui lòng chọn địa chỉ giao hàng hoặc thêm địa chỉ mới.");
            return false;
        }
        const pay = document.querySelector("input[name='paymentMethod']:checked");
        if (!pay){
            alert("Vui lòng chọn phương thức thanh toán.");
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        const first = document.querySelector("input[name='addressSelect']:checked");
        if (first){
            finalAddressId.value = first.value;
            quoteExisting(first.value);
        }
        document.querySelectorAll('input.address-radio').forEach(r=>{
            r.addEventListener('change', function(){ selectExistingAddress(this); });
        });

        wireGeoForm('na');
        wireGeoForm('ka');

        updateGrand();
    });
    /*]]>*/
</script>
</body>
</html>
