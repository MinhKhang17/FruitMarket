<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Thanh toán — Fruit Market</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

    <style>
        :root { --green: #198754; --green-dark: #156a3c; --muted: #6c757d; --card-bg:#fff; --page-bg:#f6faf6; }
        body { background: var(--page-bg); }
        .card { max-width: 980px; margin: 32px auto; border-radius: 12px; }
        .thumb { width:70px; height:70px; object-fit:cover; border-radius:8px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/notification :: notification}"></div>

<div class="container">
    <div class="card shadow-sm p-4">
        <h4 class="mb-4"><i class="bi bi-basket2-fill text-success"></i> Xác nhận đơn hàng (Giỏ hàng)</h4>

        <!-- List items from cart (supports cart.items OR selectedItems) -->
        <div class="mb-3">
            <div th:if="${selectedItems != null}">
                <div th:each="item : ${selectedItems}" class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}" class="thumb" onerror="this.src='/images/placeholder.png'"/>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" th:text="${item.name}">Tên sản phẩm</div>
                        <small class="text-muted" th:if="${item.variantName != null}">Biến thể: <span th:text="${item.variantName}">V</span></small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1" th:text="${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                        <div class="muted small">Số lượng: <span th:text="${item.quantity}">1</span></div>
                        <div class="fw-bold mt-1" th:text="${#numbers.formatDecimal(item.subTotal != null ? item.subTotal : item.price * item.quantity,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                    </div>
                </div>
            </div>

            <div th:if="${selectedItems == null}">
                <div th:each="item : ${cart.items}" class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}" class="thumb" onerror="this.src='/images/placeholder.png'"/>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" th:text="${item.name}">Tên sản phẩm</div>
                        <small class="text-muted" th:if="${item.variantName != null}">Biến thể: <span th:text="${item.variantName}">V</span></small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1" th:text="${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                        <div class="muted small">Số lượng: <span th:text="${item.quantity}">1</span></div>
                        <div class="fw-bold mt-1" th:text="${#numbers.formatDecimal(item.subTotal != null ? item.subTotal : item.price * item.quantity,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="mb-3">
                    <h6>Địa chỉ giao hàng</h6>

                    <div th:if="${userDetail != null and !#lists.isEmpty(userDetail)}">
                        <div th:each="addr, i : ${userDetail}" class="form-check">
                            <input class="form-check-input address-radio" type="radio" name="addressSelect"
                                   th:id="${'addr_'+i.index}" th:value="${addr.id}" th:checked="${i.index == 0}"
                                   onchange="setSelectedAddress(this)">
                            <label class="form-check-label" th:for="${'addr_'+i.index}">
                                <strong th:text="${addr.phone}">0123</strong> — <span th:text="${addr.address}">Địa chỉ</span>
                            </label>
                        </div>

                        <div class="mt-2">
                            <button class="btn btn-outline-success btn-sm" type="button" onclick="toggleNewAddressForm()">Thêm địa chỉ mới</button>
                        </div>

                        <form id="newAddressForm" th:action="@{/checkout/save-address}" method="post" class="mt-2 d-none">
                            <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                            <div class="mb-2">
                                <input class="form-control" name="address" placeholder="Địa chỉ mới" required/>
                            </div>
                            <div class="mb-2">
                                <input class="form-control" name="phone" placeholder="Số điện thoại" required/>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-success btn-sm">Lưu</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleNewAddressForm()">Hủy</button>
                            </div>
                        </form>
                    </div>

                    <div th:if="${userDetail == null or #lists.isEmpty(userDetail)}">
                        <div class="alert alert-warning">Bạn chưa có địa chỉ giao hàng. Vui lòng thêm địa chỉ.</div>
                        <form th:action="@{/checkout/save-address}" method="post">
                            <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                            <div class="mb-2"><input class="form-control" name="address" placeholder="Địa chỉ" required/></div>
                            <div class="mb-2"><input class="form-control" name="phone" placeholder="Số điện thoại" required/></div>
                            <button class="btn btn-success">Lưu và tiếp tục</button>
                        </form>
                    </div>

                </div>
            </div>

            <div class="col-md-6">
                <div class="p-3 bg-white rounded shadow-sm">
                    <div class="d-flex justify-content-between mb-2">
                        <div>Tổng số lượng:</div>
                        <div th:text="${totalQuantity}">0</div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <div>Tổng tiền:</div>
                        <div class="fs-5 text-success" th:text="${#numbers.formatDecimal(totalPrice,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                    </div>

                    <!-- Checkout form (points to CartController.processCartCheckoutFromCartPage) -->
                    <form th:action="@{/cart/process-checkout-from-page}" method="post" onsubmit="return finalizeCartCheckout(this);">
                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                        <input type="hidden" id="finalAddressId" name="addressId" value="" />

                        <h6>Phương thức thanh toán</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                            <label class="form-check-label" for="cod">Thanh toán khi nhận hàng</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="VNPAY">
                            <label class="form-check-label" for="bank">VNPAY</label>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <a th:href="@{/cart}" class="btn btn-outline-secondary">Quay lại giỏ hàng</a>
                            <button type="submit" class="btn btn-success">Xác nhận đặt hàng</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    function toggleNewAddressForm() {
        const frm = document.getElementById('newAddressForm');
        if (frm) frm.classList.toggle('d-none');
    }

    function setSelectedAddress(radio) {
        if (!radio) return;
        var id = radio.value;
        document.getElementById('finalAddressId').value = id;
    }

    function finalizeCartCheckout(form) {
        // ensure an address selected
        var addr = document.getElementById('finalAddressId').value;
        if (!addr) {
            alert("Vui lòng chọn địa chỉ giao hàng hoặc thêm địa chỉ mới.");
            return false;
        }
        // ensure payment selected
        var pay = document.querySelector("input[name='paymentMethod']:checked");
        if (!pay) {
            alert("Vui lòng chọn phương thức thanh toán.");
            return false;
        }
        return true;
    }

    // init: set first address if present and add listeners
    document.addEventListener('DOMContentLoaded', function () {
        const firstAddr = document.querySelector("input[name='addressSelect']:checked");
        if (firstAddr) document.getElementById('finalAddressId').value = firstAddr.value;

        // attach change listener to address radios (in case user clicks label)
        document.querySelectorAll('input.address-radio').forEach(r => {
            r.addEventListener('change', function () {
                setSelectedAddress(this);
            });
        });
    });
    /*]]>*/
</script>
</body>
</html>
