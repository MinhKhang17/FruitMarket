<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Thanh toán — Fruit Market</title>

    <!-- Bootstrap + icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

    <style>
        :root {
            --green: #198754;
            --green-dark: #156a3c;
            --muted: #6c757d;
            --card-bg: #ffffff;
            --page-bg: #f6faf6;
        }
        body { background: var(--page-bg); font-family: 'Segoe UI', Roboto, Arial, sans-serif; }
        .card { max-width: 920px; margin: 40px auto; border-radius: 12px; }
        .title { font-weight: 600; color: var(--green-dark); }
        .price { font-weight: 700; color: var(--green); font-size: 1.2rem; }
        .muted { color: var(--muted); font-size: 0.95rem; }
        .form-section { background: var(--card-bg); padding: 20px; border-radius: 10px; }
        .divider { border-top: 2px solid #e7f3ea; margin: 25px 0; }
        .btn-success { background-color: var(--green); border: none; }
        .btn-success:hover { background-color: var(--green-dark); }
        .thumb { width:90px; height:90px; object-fit:cover; border-radius:8px; }
        .small-muted { color: #95a49a; font-size: 0.85rem; }
    </style>
</head>
<body>

<!-- ✅ Header & Notification -->
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="~{fragments/notification :: notification}"></div>

<div class="container">
    <div class="card shadow-sm p-4">
        <h4 class="title mb-4"><i class="bi bi-basket2-fill text-success"></i> Xác nhận đơn hàng</h4>

        <!-- ================= SẢN PHẨM ================= -->
        <div class="form-section mb-4" th:object="${productVariant}">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img th:src="${#strings.isEmpty(productVariant.image_url) ? '/images/placeholder.png' : productVariant.image_url}"
                         alt="Ảnh sản phẩm"
                         class="thumb"
                         onerror="this.src='/images/placeholder.png'"/>
                </div>

                <div class="col">
                    <h6 class="mb-1" th:text="${productVariant.product_name}">Tên sản phẩm</h6>
                    <p class="muted mb-0" th:text="${productVariant.product_description}">Mô tả sản phẩm</p>
                </div>

                <div class="col-auto text-end">
                    <div id="displayUnitPrice" class="price"
                         th:text="${#numbers.formatDecimal(productVariant.product_price,0,'COMMA',2,'POINT')} + ' ₫'">
                        0 ₫
                    </div>
                </div>
            </div>
        </div>


        <div class="mt-3 row g-2">
                <div class="col-auto">
                    <label class="form-label">Số lượng</label>
                    <input id="quantityInput" th:value="${quantity}" type="number" min="1" value="1"
                           class="form-control" style="max-width:120px;" onchange="updateTotal()" />
                </div>

                <div class="col-auto align-self-end">
                    <label class="form-label">Tổng tạm tính</label>
                    <div id="totalPrice" class="price">—</div>
                </div>
            </div>
        </div>

        <div class="divider"></div>

    <!-- ================= ĐỊA CHỈ GIAO HÀNG ================= -->
    <div class="form-section mb-4">
        <h5 class="mb-3"><i class="bi bi-geo-alt-fill text-success"></i> Địa chỉ giao hàng</h5>

        <!-- ✅ Có địa chỉ -->
        <div th:if="${userDetail != null and !#lists.isEmpty(userDetail)}">
            <p class="text-muted">Chọn địa chỉ giao hàng hoặc thêm mới nếu cần.</p>

            <div class="list-group mb-3">
                <label th:each="addr, i : ${userDetail}"
                       class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                        <input class="form-check-input me-2" type="radio" name="addressSelect"
                               th:id="${'addr_'+i.index}" th:value="${addr.id}"
                               th:checked="${i.index == 0}" onchange="selectExistingAddress(this)">
                        <strong th:text="${addr.phone}">0123456789</strong>
                        <div class="small text-muted" th:text="${addr.address}">Địa chỉ giao hàng</div>
                    </div>
                </label>
            </div>

            <div class="text-end">
                <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleNewAddressForm()">
                    <i class="bi bi-plus-circle"></i> Thêm địa chỉ mới
                </button>
            </div>

            <!-- ✅ Form thêm mới -->
            <form id="newAddressForm" class="mt-3 d-none" th:action="@{/checkout/save-address}" method="post">
                <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                <div class="row g-2">
                    <div class="col-md-8">
                        <label class="form-label">Địa chỉ mới</label>
                        <input type="text" class="form-control" name="address"
                               placeholder="Nhập địa chỉ cụ thể..." required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" name="phone"
                               placeholder="Nhập số điện thoại..." required />
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="bi bi-check2-circle"></i> Lưu địa chỉ mới
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleNewAddressForm()">
                        Hủy
                    </button>
                </div>
            </form>
        </div>

        <!-- ✅ Không có địa chỉ -->
        <div th:if="${userDetail == null or #lists.isEmpty(userDetail)}">
            <div class="alert alert-warning py-2 mb-3" role="alert">
                ⚠️ Bạn chưa có thông tin giao hàng. Vui lòng nhập địa chỉ và số điện thoại bên dưới.
            </div>

            <form th:action="@{/checkout/save-address}" method="post" class="mb-0">
                <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                <div class="mb-3">
                    <label class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" name="address"
                           placeholder="Nhập địa chỉ cụ thể..." required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Số điện thoại</label>
                    <input type="text" class="form-control" name="phone"
                           placeholder="Nhập số điện thoại..." required />
                </div>
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-check-circle"></i> Lưu địa chỉ và tiếp tục
                </button>
            </form>
        </div>
    </div>



    <div class="divider"></div>

        <!-- ================= THANH TOÁN ================= -->
        <div class="form-section mb-4">
            <h5 class="mb-3"><i class="bi bi-credit-card text-success"></i> Phương thức thanh toán</h5>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                <label class="form-check-label" for="cod"><i class="bi bi-cash-stack text-success"></i> Thanh toán khi nhận hàng</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="BANK">
                <label class="form-check-label" for="bank"><i class="bi bi-bank text-primary"></i> Chuyển khoản ngân hàng</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" id="momo" value="MOMO">
                <label class="form-check-label" for="momo"><i class="bi bi-phone text-danger"></i> Ví MoMo</label>
            </div>
        </div>

        <!-- ================= XÁC NHẬN ================= -->
        <form th:action="@{/checkout/process}" method="post" onsubmit="return finalizeAndSubmit(this);">
            <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />

            <input type="hidden" name="variantId" th:value="${productVariant.id}" />
            <input type="hidden" id="finalQuantity" name="quantity" th:value="${quantity}" />
            <input type="hidden" id="finalAddressId" name="addressId" value="" />
            <input type="hidden" id="finalPayment" name="paymentMethod" value="COD" />

            <div class="d-flex justify-content-end gap-3 mt-3">
                <a th:href="@{/}" class="btn btn-outline-success">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
                <button type="submit" class="btn btn-success px-4">
                    <i class="bi bi-check2-circle"></i> Xác nhận đặt hàng
                </button>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const qtyInput = document.getElementById("quantityInput");
    const totalPrice = document.getElementById("totalPrice");
    const finalQty = document.getElementById("finalQuantity");
    const paymentRadios = document.querySelectorAll("input[name='paymentMethod']");
    const finalPayment = document.getElementById("finalPayment");
    const finalAddressId = document.getElementById("finalAddressId");

    const variantPrice = /*[[${productVariant.product_price}]]*/ 0;

    function fmt(num) {
        try { return Number(num).toLocaleString("vi-VN") + " ₫"; }
        catch(e) { return num; }
    }

    function updateTotal() {
        const qty = Number(qtyInput.value) || 1;
        totalPrice.textContent = fmt(variantPrice * qty);
        finalQty.value = qty;
    }

    function toggleNewAddressForm() {
        const frm = document.getElementById("newAddressForm");
        if (frm) frm.classList.toggle("d-none");
    }

    function selectExistingAddress(radio) {
        if (!radio) return;
        const frm = document.getElementById("newAddressForm");
        if (radio.value === "new") {
            frm?.classList.remove("d-none");
            finalAddressId.value = "";
        } else {
            frm?.classList.add("d-none");
            finalAddressId.value = radio.value;
        }
    }

    paymentRadios.forEach(r => r.addEventListener("change", () => finalPayment.value = r.value));

    function finalizeAndSubmit(form) {
        const qty = Number(finalQty.value) || 1;
        if (qty <= 0) { alert("Số lượng không hợp lệ."); return false; }

        const addr = finalAddressId.value;
        if (!addr) {
            alert("Vui lòng chọn hoặc nhập địa chỉ giao hàng.");
            return false;
        }
        return true;
    }

    if (qtyInput) qtyInput.addEventListener("input", updateTotal);
    document.addEventListener("DOMContentLoaded", updateTotal);
    /*]]>*/
</script>
</body>
</html>
