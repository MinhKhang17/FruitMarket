<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gi·ªè h√†ng c·ªßa b·∫°n - FruitMarket</title>

    <!-- CSRF token available to JS -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .cart-table img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .cart-summary { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
        .btn-update { padding: 4px 10px; }
        .empty-cart { text-align: center; padding: 50px 0; color: #6c757d; }
        .muted { color: #6c757d; }
        .small-muted { color: #95a49a; font-size: 0.85rem; }
        .checkbox-col { width: 48px; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<main class="py-4">
    <div class="container">

        <h2 class="mb-4 fw-bold text-success text-center">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

        <div th:if="${cart == null or #lists.isEmpty(cart.items)}" class="empty-cart">
            <p>Gi·ªè h√†ng c·ªßa b·∫°n hi·ªán ƒëang tr·ªëng.</p>
            <a class="btn btn-success" th:href="@{/products}">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>

        <div th:if="${cart != null and !#lists.isEmpty(cart.items)}" class="row g-4">
            <div class="col-lg-8">
                <div class="table-responsive shadow-sm rounded">
                    <table class="table align-middle cart-table bg-white mb-0">
                        <thead class="table-light">
                        <tr>
                            <th class="checkbox-col text-center">
                                <input id="selectAll" type="checkbox" title="Ch·ªçn t·∫•t c·∫£">
                            </th>
                            <th scope="col">S·∫£n ph·∫©m</th>
                            <th scope="col">Gi√°</th>
                            <th scope="col" style="width: 150px;">S·ªë l∆∞·ª£ng/kh·ªëi l∆∞·ª£ng (kg)</th>
                            <th scope="col">Th√†nh ti·ªÅn</th>
                            <th scope="col" class="text-center">H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item, iterStat : ${cart.items}">
                            <td class="text-center">
                                <input type="checkbox" class="select-item"
                                       th:attr="data-index=${iterStat.index},
                        data-variantid=${item.variantId != null ? item.variantId : ''},
                        data-price=${item.price != null ? item.price : 0},
                        data-qty=${item.unit == 'KILOGRAM' ? item.weight : item.quantity},
                        data-unit=${item.unit}"
                                />
                            </td>

                            <td>
                                <div class="d-flex align-items-center">
                                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/placeholder.png'}"
                                         alt="·∫¢nh s·∫£n ph·∫©m"
                                         onerror="this.src='/images/placeholder.png'">
                                    <div class="ms-3">
                                        <div class="fw-semibold" th:text="${item.name}">T√™n s·∫£n ph·∫©m</div>
                                        <small class="text-muted" th:if="${item.variantName != null}">
                                            Bi·∫øn th·ªÉ: <span th:text="${item.variantName}">Variant</span>
                                        </small>
                                    </div>
                                </div>
                            </td>

                            <td class="align-middle"
                                th:text="${item.price != null ? #numbers.formatDecimal(item.price,0,'COMMA',0,'POINT') + ' ‚Ç´' : '‚Äî'}">0 ‚Ç´
                            </td>

                            <td>
                                <form th:action="@{/cart/update}" method="post" class="d-flex align-items-center">
                                    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                                    <input type="hidden" name="productId" th:value="${item.productId}" />
                                    <input type="hidden" name="variantId" th:value="${item.variantId}" />

                                    <!-- ‚úÖ C√≥ data-index ƒë·ªÉ JS ƒë·ªçc -->
                                    <div th:if="${item.unit == 'KILOGRAM'}">
                                        <input type="number" name="qtyOrWeight" class="form-control form-control-sm text-center qty-input"
                                               step="0.1" min="0.1" th:value="${item.weight}" th:attr="data-index=${iterStat.index}" style="width:90px;">
                                    </div>

                                    <div th:if="${item.unit != 'KILOGRAM'}">
                                        <input type="number" name="qtyOrWeight" class="form-control form-control-sm text-center qty-input"
                                               min="1" th:value="${item.quantity}" th:attr="data-index=${iterStat.index}" style="width:80px;">
                                    </div>

                                    <button class="btn btn-outline-success btn-sm btn-update ms-1" type="submit" title="C·∫≠p nh·∫≠t">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                </form>
                            </td>

                            <td class="align-middle sub-total-cell"
                                th:text="${item.subTotal != null ? #numbers.formatDecimal(item.subTotal,0,'COMMA',0,'POINT') + ' ‚Ç´' : '‚Äî'}">0 ‚Ç´</td>

                            <td class="align-middle text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    <form th:action="@{/buy-now}" method="post">
                                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="productId" th:value="${item.productId}" />
                                        <input type="hidden" name="variantId" th:value="${item.variantId}" />
                                        <input type="hidden" name="qtyOrWeight" th:value="${item.unit == 'KILOGRAM' ? item.weight : item.quantity}" />
                                        <button type="submit" class="btn btn-warning btn-sm text-white" title="Mua ngay">
                                            <i class="bi bi-bag-check"></i>
                                        </button>
                                    </form>

                                    <form th:action="@{/cart/remove}" method="post">
                                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="productId" th:value="${item.productId}" />
                                        <input type="hidden" name="variantId" th:value="${item.variantId}" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="X√≥a">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 d-flex justify-content-between">
                    <form th:action="@{/cart/clear}" method="post">
                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3"></i> X√≥a to√†n b·ªô</button>
                    </form>

                    <a class="btn btn-outline-success btn-sm" th:href="@{/products}"><i class="bi bi-arrow-left"></i> Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="cart-summary">
                    <h5 class="fw-bold mb-3">T·ªïng k·∫øt gi·ªè h√†ng</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>T·ªïng s·ªë l∆∞·ª£ng (t·∫•t c·∫£):</span>
                        <strong th:text="${cart.totalQuantity}">0</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <span>T·ªïng c·ªông (t·∫•t c·∫£):</span>
                        <strong class="text-success fs-5"
                                th:text="${#numbers.formatDecimal(cart.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</strong>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="small-muted">ƒê√£ ch·ªçn</div>
                                <div><strong id="selectedQuantity">0</strong> s·∫£n ph·∫©m</div>
                            </div>
                            <div class="text-end">
                                <div class="small-muted">T·ªïng ti·ªÅn m·ª•c ƒë√£ ch·ªçn</div>
                                <div class="text-success fs-5" id="selectedTotal">0 ‚Ç´</div>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout selected items -->
                    <div class="d-grid gap-2 mb-2">
                        <button id="checkoutSelectedBtn" class="btn btn-success" disabled>Thanh to√°n m·ª•c ƒë√£ ch·ªçn</button>
                    </div>

                    <!-- Checkout whole cart (original behavior) -->
                    <form th:action="@{/cart/checkout}" method="post">
                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-outline-success w-100"><i class="bi bi-credit-card-2-front"></i> Thanh to√°n to√†n b·ªô gi·ªè</button>
                    </form>

                    <div class="mt-3 text-center">
                        <small class="muted">B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng, ch·ªçn m·ª•c r·ªìi thanh to√°n.</small>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS: t√≠nh to√°n selected total, t·∫°o form POST ƒë·ªông g·ª≠i selected items -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // L·∫•y c√°c ph·∫ßn t·ª≠ ch√≠nh
        const selectAllCheckbox = document.getElementById('selectAll');
        const selectedTotalEl = document.getElementById('selectedTotal');
        const selectedQtyEl = document.getElementById('selectedQuantity');
        const checkoutBtn = document.getElementById('checkoutSelectedBtn');

        // Helper parse v√† format
        const parseNumber = s => parseFloat(s) || 0;
        const formatVND = n => Number(n || 0).toLocaleString('vi-VN') + ' ‚Ç´';
        const getItemCheckboxes = () => Array.from(document.querySelectorAll('.select-item'));

        // ‚úÖ H√†m c·∫≠p nh·∫≠t t·ªïng ti·ªÅn v√† tr·∫°ng th√°i n√∫t
        function updateSelectedSummary() {
            const itemCheckboxes = getItemCheckboxes();
            const checked = itemCheckboxes.filter(cb => cb.checked);
            let total = 0;
            let qtySum = 0;

            checked.forEach(cb => {
                const price = parseNumber(cb.dataset.price);
                const unit = cb.dataset.unit;
                let qty = parseNumber(cb.dataset.qty);
                const idx = cb.dataset.index;

                const qInput = document.querySelector(`.qty-input[data-index="${idx}"]`);
                if (qInput) qty = parseNumber(qInput.value);

                total += price * qty;
                qtySum += 1;
            });

            selectedTotalEl.textContent = formatVND(total);
            selectedQtyEl.textContent = qtySum;
            checkoutBtn.disabled = checked.length === 0;
        }

        // ‚úÖ S·ª± ki·ªán: ch·ªçn t·∫•t c·∫£
        selectAllCheckbox?.addEventListener('change', function () {
            const all = getItemCheckboxes();
            all.forEach(cb => cb.checked = this.checked);
            updateSelectedSummary();
        });

        // ‚úÖ S·ª± ki·ªán: tick ch·ªçn item
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('select-item')) {
                updateSelectedSummary();
            }
        });

        // ‚úÖ S·ª± ki·ªán: thay ƒë·ªïi s·ªë l∆∞·ª£ng
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('qty-input')) {
                const idx = e.target.dataset.index;
                const cb = document.querySelector(`.select-item[data-index="${idx}"]`);
                if (cb) cb.dataset.qty = e.target.value;
                updateSelectedSummary();
            }
        });

        // ‚úÖ N√∫t thanh to√°n
        checkoutBtn?.addEventListener('click', function () {
            const checked = getItemCheckboxes().filter(cb => cb.checked);
            if (checked.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.');
                return;
            }

            const csrf = {
                token: document.querySelector('meta[name="_csrf"]')?.content || '',
                header: document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN'
            };

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = /*[[ @{/cart/checkout} ]]*/ '/cart/checkout';

            if (csrf.token) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = '_csrf';
                input.value = csrf.token;
                form.appendChild(input);
            }

            checked.forEach(cb => {
                const vid = cb.dataset.variantid;
                const qty = cb.dataset.qty;
                if (vid && qty) {
                    const i1 = document.createElement('input');
                    i1.type = 'hidden'; i1.name = 'variantIds'; i1.value = vid;
                    form.appendChild(i1);

                    const i2 = document.createElement('input');
                    i2.type = 'hidden'; i2.name = 'quantities'; i2.value = qty;
                    form.appendChild(i2);
                }
            });

            document.body.appendChild(form);
            form.submit();
        });

        // ‚úÖ Kh·ªüi t·∫°o ban ƒë·∫ßu
        updateSelectedSummary();
    });
    /*]]>*/
</script>

</body>
</html>