<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Products</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <!-- Page CSS -->
    <link th:href="@{/product.css}" rel="stylesheet"/>
    <style>
        /* ========== BỔ SUNG/CHỈNH để căn đều GIÁ + NÚT ========== */
        .product-card{display:flex;flex-direction:column;min-height:100%;background:#fff;border-radius:1rem;box-shadow:0 2px 10px rgba(16,24,40,.06)}
        .product-card .thumb{overflow:hidden;border-top-left-radius:1rem;border-top-right-radius:1rem}
        .product-card .thumb img{width:100%;height:100%;object-fit:cover}
        .product-card .content{display:flex;flex-direction:column;flex:1}
        .product-card .price-row{margin-top:auto;display:flex;align-items:center;gap:.5rem}
        /* ========================================================= */

        .products-page .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:.85rem}
        .products-page .chip-dismiss{cursor:pointer}
        .btn-outline-leaf{--bs-btn-color:#2f9e44;--bs-btn-border-color:#2f9e44;--bs-btn-hover-bg:#2f9e44;--bs-btn-hover-color:#fff}
        .btn-leaf{background:#2f9e44;color:#fff}
        .btn-leaf:hover{opacity:.95;color:#fff}
        .col-xl-2p4{flex:0 0 20%;max-width:20%}
        @media(max-width:1199.98px){.col-xl-2p4{flex:0 0 25%;max-width:25%}}
        .pagination-soft .page-link{border-radius:8px;margin:0 .125rem}
        .empty-illustration{opacity:.6}
        .clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .price{font-weight:700;color:#2f9e44}

        /* Nút View + Thêm nằm cùng hàng */
        .product-actions{display:flex;gap:.5rem;margin-top:.5rem}
        .btn-view-product{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #e5e7eb;border-radius:.6rem;padding:.4rem .6rem;text-decoration:none}
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="container products-page my-4">
    <!-- Heading -->
    <div class="simple-heading mb-3">
        <h1 class="page-title h3 mb-1">All Products</h1>
        <p class="page-subtitle text-secondary">Bộ sưu tập sản phẩm mới nhất</p>
    </div>

    <!-- Empty state -->
    <div th:if="${#lists.isEmpty(products)}" class="no-product text-center py-5">
        <div class="empty-illustration display-4 mb-2"><i class="bi bi-emoji-frown"></i></div>
        <p>Hiện chưa có sản phẩm để trưng bày.</p>
    </div>

    <!-- Toolbar -->
    <section class="toolbar" th:if="${!#lists.isEmpty(products)}">
        <div class="row g-2 g-md-3 align-items-stretch">
            <div class="col-12 col-md-4 col-lg-3">
                <input id="search" class="form-control" placeholder="Tìm theo tên sản phẩm...">
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <input id="minPrice" type="number" min="0" step="1000" class="form-control" placeholder="Giá tối thiểu (₫)">
            </div>
            <div class="col-6 col-md-4 col-lg-3">
                <input id="maxPrice" type="number" min="0" step="1000" class="form-control" placeholder="Giá tối đa (₫)">
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="cat" class="form-select" aria-label="Lọc theo danh mục">
                    <option value="">Tất cả danh mục</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="brand" class="form-select" aria-label="Lọc theo thương hiệu">
                    <option value="">Tất cả thương hiệu</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="sort" class="form-select" aria-label="Sắp xếp sản phẩm">
                    <option value="default">Sắp xếp: Mặc định</option>
                    <option value="priceAsc">Giá: thấp → cao</option>
                    <option value="priceDesc">Giá: cao → thấp</option>
                    <option value="nameAsc">Tên: A → Z</option>
                    <option value="nameDesc">Tên: Z → A</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="size" class="form-select" aria-label="Số lượng sản phẩm trên mỗi trang">
                    <option value="10">10 / trang</option>
                    <option value="20">20 / trang</option>
                    <option value="40">40 / trang</option>
                </select>
            </div>
        </div>

        <div class="active-filters d-flex flex-wrap align-items-center gap-2 mt-3">
            <div id="chips" class="chips"></div>
            <button id="resetAll" type="button" class="btn btn-outline-leaf btn-sm d-none">
                <i class="bi bi-x-circle me-1"></i>Reset
            </button>
            <div class="ms-auto small text-muted" id="resultCount"></div>
        </div>
    </section>

    <!-- Product grid -->
    <section class="products-wrapper" th:if="${!#lists.isEmpty(products)}">
        <div class="row g-3 g-xl-4 justify-content-center" id="grid">
            <!-- 5 cột/hàng ở ≥1200px nhờ .col-xl-2p4 -->
            <div class="col-6 col-md-4 col-lg-3 col-xl-2p4" th:each="p : ${products}">
                <article class="product-card h-100 d-flex flex-column"
                         th:attr="data-price=${
                           (p.variants != null and !#lists.isEmpty(p.variants) and p.variants[0].price != null)
                             ? p.variants[0].price
                             : null
                         }"
                         th:data-name="${#strings.toLowerCase(p.productName)}"
                         th:data-cat="${p.category != null ? p.category.name : ''}"
                         th:data-brand="${p.brand != null ? p.brand.name : ''}">
                    <!-- Ảnh -->
                    <a class="thumb ratio ratio-4x3" th:href="@{|/products/${p.id}|}" target="_top" aria-label="Xem chi tiết">
                        <img
                                th:src="${
                              (p.variants != null and !#lists.isEmpty(p.variants)
                               and p.variants[0].image != null
                               and p.variants[0].image.url != null and !#strings.isEmpty(p.variants[0].image.url))
                                ? p.variants[0].image.url
                                : '/images/placeholder.png'
                            }"
                                th:alt="${p.productName}"
                                onerror="this.src='/images/placeholder.png'"/>
                    </a>

                    <!-- Nội dung -->
                    <div class="content px-3 py-3 d-flex flex-column gap-2">
                        <h2 class="product-name text-truncate" th:text="${p.productName}">Product name</h2>

                        <div class="chips">
                            <span class="chip" th:text="${p.category != null ? p.category.name : '—'}">Category</span>
                            <span class="chip" th:text="${p.brand != null ? p.brand.name : '—'}">Brand</span>
                        </div>

                        <p class="product-desc clamp-2" th:text="${p.product_description}">Mô tả ngắn…</p>

                        <div class="price-row">
                          <span class="price"
                                th:text="${
                                  (p.variants != null and !#lists.isEmpty(p.variants) and p.variants[0].price != null)
                                    ? '₫ ' + #numbers.formatDecimal(p.variants[0].price, 0, 'COMMA', 0, 'POINT')
                                    : 'Liên hệ'
                                }">₫ 0</span>
                        </div>

                        <!-- Hành động: Xem chi tiết + Thêm vào giỏ -->
                        <div class="product-actions">
                            <a class="btn btn-view-product flex-fill" th:href="@{|/products/${p.id}|}" target="_top">
                                <i class="bi bi-eye"></i> Xem
                            </a>
                            <!-- ✅ Nút mở Modal thêm vào giỏ -->
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm"
                                    data-bs-toggle="modal"
                                    th:attr="data-bs-target=${'#addToCartModal-' + p.id}">
                                <i class="bi bi-cart-plus me-1"></i> Thêm
                            </button>
                        </div>
                    </div>
                </article>

                <!-- ✅ Modal Add to Cart cho từng sản phẩm -->
                <div class="modal fade" th:id="${'addToCartModal-' + p.id}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <form th:action="@{/cart/add}" method="post" class="modal-form">
                                <div class="modal-header">
                                    <h5 class="modal-title" th:text="${p.productName}">Product</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>

                                <div class="modal-body">
                                    <!-- CSRF -->
                                    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />

                                    <!-- product id -->
                                    <input type="hidden" name="productId" th:value="${p.id}" />

                                    <!-- Hidden variant id (2 tên field để tương thích BE) -->
                                    <input type="hidden" name="product_variant_id"
                                           th:id="${'modal_product_variant_id_' + p.id}"
                                           th:value="${(p.variants != null and !#lists.isEmpty(p.variants)) ? p.variants.get(0).id : ''}" />
                                    <input type="hidden" name="variantId"
                                           th:id="${'modal_variantId_' + p.id}"
                                           th:value="${(p.variants != null and !#lists.isEmpty(p.variants)) ? p.variants.get(0).id : ''}" />

                                    <!-- Danh sách biến thể -->
                                    <div th:if="${p.variants != null and !#lists.isEmpty(p.variants)}" class="mb-3">
                                        <label class="form-label"><strong>Chọn biến thể</strong></label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button"
                                                    th:each="v, idx : ${p.variants}"
                                                    class="btn btn-outline-secondary variant-select-btn"
                                                    th:classappend="${idx.index == 0} ? ' active' : ''"
                                                    th:attr="data-variant-id=${v.id}, data-stock=${v.stock}, data-price=${v.price}, data-image=${v.image != null && v.image.url != null ? v.image.url : ''}, data-index=${idx.index}">
                                                <span th:text="${v.variant_name}">Variant</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Số lượng / Khối lượng -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Số lượng</strong></label>

                                        <!-- Hàng theo kg -->
                                        <div th:if="${p.unit != null and p.unit.name() == 'KILOGRAM'}"
                                             class="d-flex align-items-center gap-2">
                                            <input type="number" name="weight" th:id="${'modalWeight-' + p.id}"
                                                   step="0.1" min="0.1" value="1"
                                                   class="form-control modal-weight" style="width:160px;" />
                                            <span>kg</span>
                                            <div class="ms-2 small text-muted"
                                                 th:id="${'modalStockHintWeight-' + p.id}"></div>
                                        </div>

                                        <!-- Hàng theo cái/rổ/... -->
                                        <div th:if="${p.unit == null or p.unit.name() != 'KILOGRAM'}"
                                             class="d-flex align-items-center gap-2">
                                            <input type="number" name="quantity" th:id="${'modalQty-' + p.id}"
                                                   min="1" value="1"
                                                   class="form-control modal-qty" style="width:120px;" />
                                            <span th:text="${p.unit != null ? (p.unit.name() == 'BASKET' ? 'rổ' : (p.unit.name() == 'PIECE' ? 'cái' : p.unit.name().toLowerCase())) : 'cái'}">cái</span>
                                            <div class="ms-2 small text-muted"
                                                 th:id="${'modalStockHintQty-' + p.id}"></div>
                                        </div>
                                    </div>

                                    <!-- Giá dự kiến -->
                                    <div class="mb-2">
                                        Giá dự kiến:
                                        <strong class="text-success" th:id="${'modalPrice-' + p.id}"
                                                th:text="${(p.variants != null and !#lists.isEmpty(p.variants))
                                                    ? #numbers.formatDecimal(p.variants.get(0).price,0,'POINT',0,'COMMA')
                                                    : (p.price != null ? #numbers.formatDecimal(p.price,0,'POINT',0,'COMMA') : '0')}">0</strong> ₫
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-primary btn-add-to-cart">
                                        Thêm vào giỏ
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- /Modal -->
            </div>
        </div>
    </section>

    <!-- Pagination -->
    <nav id="pager" class="d-flex justify-content-center mt-3" aria-label="Pagination"
         th:if="${!#lists.isEmpty(products)}"></nav>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Filter + Sort + Pagination (no search) -->
<script>
    (function () {
        const grid   = document.getElementById('grid');
        const pager  = document.getElementById('pager');
        const $search = document.getElementById('search');
        const $minPrice = document.getElementById('minPrice');
        const $maxPrice = document.getElementById('maxPrice');
        const $cat   = document.getElementById('cat');
        const $brand = document.getElementById('brand');
        const $sort  = document.getElementById('sort');
        const $size  = document.getElementById('size');
        const $chips = document.getElementById('chips');
        const $reset = document.getElementById('resetAll');
        const $count = document.getElementById('resultCount');

        if (!grid || !pager) return;

        let items = Array.from(grid.children).filter(el => el.matches('[class*="col-"]'));
        items.forEach((col, i) => col.dataset.initialIndex = String(i));

        const cats = new Set(), brands = new Set();
        items.forEach(col => {
            const card = col.querySelector('.product-card');
            const c = (card?.dataset.cat || '').trim();
            const b = (card?.dataset.brand || '').trim();
            if (c) cats.add(c);
            if (b) brands.add(b);
        });
        [...cats].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const opt=document.createElement('option');opt.value=v;opt.textContent=v;$cat.appendChild(opt);
        });
        [...brands].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const opt=document.createElement('option');opt.value=v;opt.textContent=v;$brand.appendChild(opt);
        });

        const state = { search:'', minPrice:'', maxPrice:'', cat:'', brand:'', sort:'default', size:20, page:1 };
        $size.value = String(state.size);

        function getPrice(col){
            const card = col.querySelector('.product-card');
            let v = card?.dataset.price ?? '';
            if (v === '' || v === 'null' || v === 'undefined') {
                const txt = col.querySelector('.price')?.textContent || '';
                const digits = txt.replace(/[^\d]/g,'');
                if (digits) v = Number(digits);
            }
            const num = Number(v);
            return Number.isFinite(num) ? num : Infinity;
        }

        function getName(col){
            const d = col.querySelector('.product-card')?.dataset.name || '';
            const h2 = col.querySelector('.product-name')?.textContent || '';
            return (d || h2).toLowerCase();
        }

        function priceCompare(a, b, dir) {
            const pa = getPrice(a), pb = getPrice(b);
            const fa = Number.isFinite(pa), fb = Number.isFinite(pb);
            if (!fa && !fb) return 0;
            if (!fa) return 1;
            if (!fb) return -1;
            return dir === 'asc' ? (pa - pb) : (pb - pa);
        }

        function apply() {
            let filtered = items.filter(col=>{
                const card = col.querySelector('.product-card');
                const c = (card?.dataset.cat || '').trim();
                const b = (card?.dataset.brand || '').trim();
                const name = getName(col);
                const price = getPrice(col);

                // Filter by search text
                const matchSearch = state.search ? name.includes(state.search.toLowerCase()) : true;

                // Filter by category
                const inC = state.cat ? c.toLowerCase() === state.cat.toLowerCase() : true;

                // Filter by brand
                const inB = state.brand ? b.toLowerCase() === state.brand.toLowerCase() : true;

                // Filter by price range
                let matchPrice = true;
                if (Number.isFinite(price)) {
                    if (state.minPrice !== '' && price < Number(state.minPrice)) matchPrice = false;
                    if (state.maxPrice !== '' && price > Number(state.maxPrice)) matchPrice = false;
                }

                return matchSearch && inC && inB && matchPrice;
            });

            const sorted = filtered.slice().sort((a,b)=>{
                switch(state.sort){
                    case 'priceAsc': return priceCompare(a,b,'asc');
                    case 'priceDesc': return priceCompare(a,b,'desc');
                    case 'nameAsc': return getName(a).localeCompare(getName(b), 'vi', { sensitivity: 'base' });
                    case 'nameDesc': return getName(b).localeCompare(getName(a), 'vi', { sensitivity: 'base' });
                    default: return Number(a.dataset.initialIndex) - Number(b.dataset.initialIndex);
                }
            });

            const total = sorted.length;
            const pages = Math.max(1, Math.ceil(total / state.size));
            if (state.page > pages) state.page = pages;
            const start = (state.page - 1) * state.size;
            const end   = start + state.size;

            const frag = document.createDocumentFragment();
            sorted.forEach(el => frag.appendChild(el));
            grid.appendChild(frag);

            items.forEach(el => el.style.display='none');
            sorted.slice(start,end).forEach(el => el.style.display='');

            renderPager(pages);
            renderChips(total);
            $count.textContent = total ?
                `Hiển thị ${Math.min(total,end)-start} / ${total} sản phẩm` :
                'Không có sản phẩm phù hợp';
        }

        function renderPager(pages){
            if (pages <= 1) { pager.innerHTML=''; return; }
            const ul=document.createElement('ul');
            ul.className='pagination pagination-soft';
            ul.appendChild(pageLi('«', state.page===1, ()=>{state.page--;apply();}));
            for(let i=1;i<=pages;i++){
                ul.appendChild(pageLi(String(i), false, ()=>{state.page=i;apply();}, i===state.page));
            }
            ul.appendChild(pageLi('»', state.page===pages, ()=>{state.page++;apply();}));
            pager.innerHTML='';pager.appendChild(ul);
        }
        function pageLi(text, disabled, onClick, active=false){
            const li=document.createElement('li');
            li.className='page-item'+(disabled?' disabled':'')+(active?' active':'');
            const a=document.createElement('a');
            a.className='page-link';a.href='#';a.textContent=text;
            a.addEventListener('click',e=>{e.preventDefault();if(!disabled)onClick();});
            li.appendChild(a);return li;
        }

        function renderChips(total){
            const $chips = document.getElementById('chips');
            const $reset = document.getElementById('resetAll');

            $chips.innerHTML='';
            const defs=[];
            if(state.search) defs.push({k:'search',label:`Tìm: "${state.search}"`});
            if(state.minPrice!=='') defs.push({k:'minPrice',label:`Giá tối thiểu: ₫${Number(state.minPrice).toLocaleString('vi-VN')}`});
            if(state.maxPrice!=='') defs.push({k:'maxPrice',label:`Giá tối đa: ₫${Number(state.maxPrice).toLocaleString('vi-VN')}`});
            if(state.cat) defs.push({k:'cat',label:`Danh mục: ${state.cat}`});
            if(state.brand) defs.push({k:'brand',label:`Thương hiệu: ${state.brand}`});
            if(state.sort!=='default'){
                const map={priceAsc:'Giá ↑',priceDesc:'Giá ↓',nameAsc:'Tên A→Z',nameDesc:'Tên Z→A'};
                defs.push({k:'sort',label:`Sắp xếp: ${map[state.sort]}`});
            }
            if(state.size!==20) defs.push({k:'size',label:`${state.size}/trang`});

            defs.forEach(def=>{
                const b=document.createElement('button');
                b.type='button';b.className='chip chip-dismiss';
                b.innerHTML=`<i class="bi bi-x"></i> ${def.label}`;
                b.addEventListener('click',()=>{
                    if(def.k==='search'){state.search='';$search.value='';}
                    if(def.k==='minPrice'){state.minPrice='';$minPrice.value='';}
                    if(def.k==='maxPrice'){state.maxPrice='';$maxPrice.value='';}
                    if(def.k==='cat'){state.cat='';$cat.value='';}
                    if(def.k==='brand'){state.brand='';$brand.value='';}
                    if(def.k==='sort'){state.sort='default';$sort.value='default';}
                    if(def.k==='size'){state.size=20;$size.value='20';}
                    state.page=1;apply();
                });
                $chips.appendChild(b);
            });

            const hasActiveFilters = state.search || state.minPrice!=='' || state.maxPrice!=='' ||
                                    state.cat || state.brand || state.sort!=='default' || state.size!==20;
            $reset.classList.toggle('d-none', !hasActiveFilters);
            $reset.onclick=()=>{
                state.search='';state.minPrice='';state.maxPrice='';
                state.cat='';state.brand='';state.sort='default';state.size=20;state.page=1;
                $search.value='';$minPrice.value='';$maxPrice.value='';
                $cat.value='';$brand.value='';$sort.value='default';$size.value='20';
                apply();
            };
        }

        // Event listeners
        let searchTimer;
        $search.addEventListener('input',()=>{
            clearTimeout(searchTimer);
            searchTimer = setTimeout(()=>{
                state.search=$search.value.trim();
                state.page=1;
                apply();
            }, 300);
        });

        $minPrice.addEventListener('input',()=>{
            state.minPrice=$minPrice.value.trim();
            state.page=1;
            apply();
        });

        $maxPrice.addEventListener('input',()=>{
            state.maxPrice=$maxPrice.value.trim();
            state.page=1;
            apply();
        });

        $cat.addEventListener('change',()=>{state.cat=$cat.value;state.page=1;apply();});
        $brand.addEventListener('change',()=>{state.brand=$brand.value;state.page=1;apply();});
        $sort.addEventListener('change',()=>{state.sort=$sort.value;state.page=1;apply();});
        $size.addEventListener('change',()=>{state.size=parseInt($size.value,10);state.page=1;apply();});

        apply();
    })();
</script>

<!-- ✅ Script xử lý modal: chọn biến thể, sync giá/stock, validate trước khi submit -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // chọn biến thể
        document.querySelectorAll('.variant-select-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const modal = btn.closest('.modal');
                if (!modal) return;

                modal.querySelectorAll('.variant-select-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const variantId = btn.getAttribute('data-variant-id');
                const stock = btn.getAttribute('data-stock');
                const price = btn.getAttribute('data-price');

                const vInput1 = modal.querySelector('input[name="product_variant_id"]');
                const vInput2 = modal.querySelector('input[name="variantId"]');
                if (vInput1) vInput1.value = variantId || '';
                if (vInput2) vInput2.value = variantId || '';

                modal.dataset.basePrice = price;

                const priceEl = modal.querySelector('[id^="modalPrice-"]');
                const qtyInput = modal.querySelector('input[name="quantity"].modal-qty');
                const weightInput = modal.querySelector('input[name="weight"].modal-weight');

                let multiplier = 1;
                if (weightInput) multiplier = Number(weightInput.value) && Number(weightInput.value) > 0 ? Number(weightInput.value) : 1;
                else if (qtyInput) multiplier = Number(qtyInput.value) && Number(qtyInput.value) > 0 ? Number(qtyInput.value) : 1;

                if (priceEl && price != null) priceEl.textContent = Number(price * multiplier).toLocaleString('vi-VN');

                const stockHintQty = modal.querySelector('[id^="modalStockHintQty-"]');
                const qtyIn = modal.querySelector('input[name="quantity"]');
                if (stockHintQty) stockHintQty.textContent = stock ? ('(Còn ' + stock + ' sản phẩm)') : '';
                if (qtyIn && stock) { qtyIn.max = stock; if (Number(qtyIn.value) > Number(stock)) qtyIn.value = stock; }

                const stockHintWeight = modal.querySelector('[id^="modalStockHintWeight-"]');
                if (stockHintWeight) stockHintWeight.textContent = stock ? ('(Còn ' + stock + ')') : '';

                const imageUrl = btn.getAttribute('data-image');
                const previewImg = modal.querySelector('.modal-image-preview img');
                if (previewImg && imageUrl) previewImg.src = imageUrl;
            });
        });

        // auto chọn biến thể đầu
        document.querySelectorAll('.modal').forEach(modalEl => {
            modalEl.addEventListener('show.bs.modal', function () {
                const first = modalEl.querySelector('.variant-select-btn');
                if (first) first.click();
            });

            // cập nhật giá theo qty/weight
            modalEl.querySelectorAll('.modal-qty, .modal-weight').forEach(inp => {
                const updatePriceFromInput = function () {
                    const base = Number(modalEl.dataset.basePrice || modalEl.querySelector('.variant-select-btn.active')?.getAttribute('data-price') || 0);
                    const qty = Number(modalEl.querySelector('input[name="quantity"]')?.value || 0);
                    const weight = Number(modalEl.querySelector('input[name="weight"]')?.value || 0);
                    const multiplier = weight > 0 ? weight : (qty > 0 ? qty : 1);
                    const priceEl = modalEl.querySelector('[id^="modalPrice-"]');
                    if (priceEl) priceEl.textContent = Number(base * multiplier).toLocaleString('vi-VN');
                };
                inp.addEventListener('input', updatePriceFromInput);
                inp.addEventListener('change', updatePriceFromInput);
            });
        });

        // validate before submit
        document.querySelectorAll('.modal-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                const modal = form.closest('.modal');
                const weightInput = form.querySelector('input[name="weight"]');
                const qtyInput = form.querySelector('input[name="quantity"]');
                const variantBtns = form.querySelectorAll('.variant-select-btn');
                const variantHidden = form.querySelector('input[name="product_variant_id"]') || form.querySelector('input[name="variantId"]');

                // đảm bảo có biến thể nếu có danh sách biến thể
                if (variantBtns.length > 0) {
                    if (!variantHidden || !variantHidden.value) {
                        e.preventDefault(); alert('Vui lòng chọn biến thể trước khi thêm vào giỏ!'); return;
                    }
                }

                // helper tạo hidden nếu cần
                const ensureHidden = (name, value) => {
                    let h = form.querySelector('input[type="hidden"][name="'+name+'"]');
                    if (!h) { h = document.createElement('input'); h.type='hidden'; h.name=name; form.appendChild(h); }
                    h.value = value;
                };

                if (weightInput) {
                    const w = Number(weightInput.value || 0);
                    if (w <= 0) { e.preventDefault(); alert('Số kg không hợp lệ!'); return; }
                    ensureHidden('weight', w);
                } else if (qtyInput) {
                    const q = Number(qtyInput.value || 0);
                    if (q <= 0) { e.preventDefault(); alert('Số lượng không hợp lệ!'); return; }
                    if (qtyInput.max && q > Number(qtyInput.max)) { e.preventDefault(); alert('Số lượng vượt quá tồn kho!'); return; }
                    ensureHidden('quantity', Math.floor(q));
                }
            });
        });
    });
</script>
</body>
</html>
