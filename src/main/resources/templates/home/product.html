<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Products</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <!-- Page CSS -->
    <link th:href="@{/product.css}" rel="stylesheet"/>
    <style>
        /* ========== BỔ SUNG/CHỈNH để căn đều GIÁ + NÚT ========== */
        .product-card{display:flex;flex-direction:column;min-height:100%;background:#fff;border-radius:1rem;box-shadow:0 2px 10px rgba(16,24,40,.06)}
        .product-card .thumb{overflow:hidden;border-top-left-radius:1rem;border-top-right-radius:1rem}
        .product-card .thumb img{width:100%;height:100%;object-fit:cover}
        .product-card .content{display:flex;flex-direction:column;flex:1}
        .product-card .price-row{margin-top:auto;display:flex;align-items:center;gap:.5rem}
        /* ========================================================= */

        .products-page .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:.85rem}
        .products-page .chip-dismiss{cursor:pointer}
        .btn-outline-leaf{--bs-btn-color:#2f9e44;--bs-btn-border-color:#2f9e44;--bs-btn-hover-bg:#2f9e44;--bs-btn-hover-color:#fff}
        .btn-leaf{background:#2f9e44;color:#fff}
        .btn-leaf:hover{opacity:.95;color:#fff}
        .col-xl-2p4{flex:0 0 20%;max-width:20%}
        @media(max-width:1199.98px){.col-xl-2p4{flex:0 0 25%;max-width:25%}}
        .pagination-soft .page-link{border-radius:8px;margin:0 .125rem}
        .empty-illustration{opacity:.6}
        .clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .price{font-weight:700;color:#2f9e44}
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="container products-page my-4">
    <!-- Heading -->
    <div class="simple-heading mb-3">
        <h1 class="page-title h3 mb-1">All Products</h1>
        <p class="page-subtitle text-secondary">Bộ sưu tập sản phẩm mới nhất</p>
    </div>

    <!-- Empty state -->
    <div th:if="${#lists.isEmpty(products)}" class="no-product text-center py-5">
        <div class="empty-illustration display-4 mb-2"><i class="bi bi-emoji-frown"></i></div>
        <p>Hiện chưa có sản phẩm để trưng bày.</p>
    </div>

    <!-- Toolbar -->
    <section class="toolbar" th:if="${!#lists.isEmpty(products)}">
        <div class="row g-2 g-md-3 align-items-stretch">
            <div class="col-12 col-md-4 col-lg-3">
                <input id="search" class="form-control" placeholder="Tìm theo tên sản phẩm...">
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <input id="minPrice" type="number" min="0" step="1000" class="form-control" placeholder="Giá tối thiểu (₫)">
            </div>
            <div class="col-6 col-md-4 col-lg-3">
                <input id="maxPrice" type="number" min="0" step="1000" class="form-control" placeholder="Giá tối đa (₫)">
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="cat" class="form-select" aria-label="Lọc theo danh mục">
                    <option value="">Tất cả danh mục</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="brand" class="form-select" aria-label="Lọc theo thương hiệu">
                    <option value="">Tất cả thương hiệu</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="sort" class="form-select" aria-label="Sắp xếp sản phẩm">
                    <option value="default">Sắp xếp: Mặc định</option>
                    <option value="priceAsc">Giá: thấp → cao</option>
                    <option value="priceDesc">Giá: cao → thấp</option>
                    <option value="nameAsc">Tên: A → Z</option>
                    <option value="nameDesc">Tên: Z → A</option>
                </select>
            </div>

            <div class="col-6 col-md-4 col-lg-3">
                <select id="size" class="form-select" aria-label="Số lượng sản phẩm trên mỗi trang">
                    <option value="10">10 / trang</option>
                    <option value="20">20 / trang</option>
                    <option value="40">40 / trang</option>
                </select>
            </div>
        </div>

        <div class="active-filters d-flex flex-wrap align-items-center gap-2 mt-3">
            <div id="chips" class="chips"></div>
            <button id="resetAll" type="button" class="btn btn-outline-leaf btn-sm d-none">
                <i class="bi bi-x-circle me-1"></i>Reset
            </button>
            <div class="ms-auto small text-muted" id="resultCount"></div>
        </div>
    </section>

    <!-- Product grid -->
    <section class="products-wrapper" th:if="${!#lists.isEmpty(products)}">
        <div class="row g-3 g-xl-4 justify-content-center" id="grid">
            <!-- 5 cột/hàng ở ≥1200px nhờ .col-xl-2p4 -->
            <div class="col-6 col-md-4 col-lg-3 col-xl-2p4" th:each="p : ${products}">
                <article class="product-card h-100 d-flex flex-column"
                         th:attr="data-price=${
                           (p.variants != null and !#lists.isEmpty(p.variants) and p.variants[0].price != null)
                             ? p.variants[0].price
                             : null
                         }"
                         th:data-name="${#strings.toLowerCase(p.productName)}"
                         th:data-cat="${p.category != null ? p.category.name : ''}"
                         th:data-brand="${p.brand != null ? p.brand.name : ''}">
                    <!-- Ảnh -->
                    <a class="thumb ratio ratio-4x3" th:href="@{|/products/${p.id}|}" target="_top" aria-label="Xem chi tiết">
                        <img
                                th:src="${
                              (p.variants != null and !#lists.isEmpty(p.variants)
                               and p.variants[0].image != null
                               and p.variants[0].image.url != null and !#strings.isEmpty(p.variants[0].image.url))
                                ? p.variants[0].image.url
                                : '/images/placeholder.png'
                            }"
                                th:alt="${p.productName}"
                                onerror="this.src='/images/placeholder.png'"/>
                    </a>

                    <!-- Nội dung -->
                    <div class="content px-3 py-3 d-flex flex-column gap-2">
                        <h2 class="product-name text-truncate" th:text="${p.productName}">Product name</h2>

                        <div class="chips">
                            <span class="chip" th:text="${p.category != null ? p.category.name : '—'}">Category</span>
                            <span class="chip" th:text="${p.brand != null ? p.brand.name : '—'}">Brand</span>
                        </div>

                        <p class="product-desc clamp-2" th:text="${p.product_description}">Mô tả ngắn…</p>

                        <div class="price-row">
                          <span class="price"
                                th:text="${
                                  (p.variants != null and !#lists.isEmpty(p.variants) and p.variants[0].price != null)
                                    ? '₫ ' + #numbers.formatDecimal(p.variants[0].price, 0, 'COMMA', 0, 'POINT')
                                    : 'Liên hệ'
                                }">₫ 0</span>
                        </div>

                        <a class="btn btn-leaf w-100" th:href="@{|/products/${p.id}|}" target="_top">Xem chi tiết</a>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- Pagination -->
    <nav id="pager" class="d-flex justify-content-center mt-3" aria-label="Pagination"
         th:if="${!#lists.isEmpty(products)}"></nav>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Filter + Sort + Pagination (no search) -->
<script>
    (function () {
        const grid   = document.getElementById('grid');
        const pager  = document.getElementById('pager');
        const $search = document.getElementById('search');
        const $minPrice = document.getElementById('minPrice');
        const $maxPrice = document.getElementById('maxPrice');
        const $cat   = document.getElementById('cat');
        const $brand = document.getElementById('brand');
        const $sort  = document.getElementById('sort');
        const $size  = document.getElementById('size');
        const $chips = document.getElementById('chips');
        const $reset = document.getElementById('resetAll');
        const $count = document.getElementById('resultCount');

        if (!grid || !pager) return;

        let items = Array.from(grid.children).filter(el => el.matches('[class*="col-"]'));
        items.forEach((col, i) => col.dataset.initialIndex = String(i));

        const cats = new Set(), brands = new Set();
        items.forEach(col => {
            const card = col.querySelector('.product-card');
            const c = (card?.dataset.cat || '').trim();
            const b = (card?.dataset.brand || '').trim();
            if (c) cats.add(c);
            if (b) brands.add(b);
        });
        [...cats].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const opt=document.createElement('option');opt.value=v;opt.textContent=v;$cat.appendChild(opt);
        });
        [...brands].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const opt=document.createElement('option');opt.value=v;opt.textContent=v;$brand.appendChild(opt);
        });

        const state = { search:'', minPrice:'', maxPrice:'', cat:'', brand:'', sort:'default', size:20, page:1 };
        $size.value = String(state.size);

        function getPrice(col){
            const card = col.querySelector('.product-card');
            let v = card?.dataset.price ?? '';
            if (v === '' || v === 'null' || v === 'undefined') {
                const txt = col.querySelector('.price')?.textContent || '';
                const digits = txt.replace(/[^\d]/g,'');
                if (digits) v = Number(digits);
            }
            const num = Number(v);
            return Number.isFinite(num) ? num : Infinity;
        }

        function getName(col){
            const d = col.querySelector('.product-card')?.dataset.name || '';
            const h2 = col.querySelector('.product-name')?.textContent || '';
            return (d || h2).toLowerCase();
        }

        function priceCompare(a, b, dir) {
            const pa = getPrice(a), pb = getPrice(b);
            const fa = Number.isFinite(pa), fb = Number.isFinite(pb);
            if (!fa && !fb) return 0;
            if (!fa) return 1;
            if (!fb) return -1;
            return dir === 'asc' ? (pa - pb) : (pb - pa);
        }

        function apply() {
            let filtered = items.filter(col=>{
                const card = col.querySelector('.product-card');
                const c = (card?.dataset.cat || '').trim();
                const b = (card?.dataset.brand || '').trim();
                const name = getName(col);
                const price = getPrice(col);

                // Filter by search text
                const matchSearch = state.search ? name.includes(state.search.toLowerCase()) : true;

                // Filter by category
                const inC = state.cat ? c.toLowerCase() === state.cat.toLowerCase() : true;

                // Filter by brand
                const inB = state.brand ? b.toLowerCase() === state.brand.toLowerCase() : true;

                // Filter by price range
                let matchPrice = true;
                if (Number.isFinite(price)) {
                    if (state.minPrice !== '' && price < Number(state.minPrice)) matchPrice = false;
                    if (state.maxPrice !== '' && price > Number(state.maxPrice)) matchPrice = false;
                }

                return matchSearch && inC && inB && matchPrice;
            });

            const sorted = filtered.slice().sort((a,b)=>{
                switch(state.sort){
                    case 'priceAsc': return priceCompare(a,b,'asc');
                    case 'priceDesc': return priceCompare(a,b,'desc');
                    case 'nameAsc': return getName(a).localeCompare(getName(b), 'vi', { sensitivity: 'base' });
                    case 'nameDesc': return getName(b).localeCompare(getName(a), 'vi', { sensitivity: 'base' });
                    default: return Number(a.dataset.initialIndex) - Number(b.dataset.initialIndex);
                }
            });

            const total = sorted.length;
            const pages = Math.max(1, Math.ceil(total / state.size));
            if (state.page > pages) state.page = pages;
            const start = (state.page - 1) * state.size;
            const end   = start + state.size;

            const frag = document.createDocumentFragment();
            sorted.forEach(el => frag.appendChild(el));
            grid.appendChild(frag);

            items.forEach(el => el.style.display='none');
            sorted.slice(start,end).forEach(el => el.style.display='');

            renderPager(pages);
            renderChips(total);
            $count.textContent = total ?
                `Hiển thị ${Math.min(total,end)-start} / ${total} sản phẩm` :
                'Không có sản phẩm phù hợp';
        }

        function renderPager(pages){
            if (pages <= 1) { pager.innerHTML=''; return; }
            const ul=document.createElement('ul');
            ul.className='pagination pagination-soft';
            ul.appendChild(pageLi('«', state.page===1, ()=>{state.page--;apply();}));
            for(let i=1;i<=pages;i++){
                ul.appendChild(pageLi(String(i), false, ()=>{state.page=i;apply();}, i===state.page));
            }
            ul.appendChild(pageLi('»', state.page===pages, ()=>{state.page++;apply();}));
            pager.innerHTML='';pager.appendChild(ul);
        }
        function pageLi(text, disabled, onClick, active=false){
            const li=document.createElement('li');
            li.className='page-item'+(disabled?' disabled':'')+(active?' active':'');
            const a=document.createElement('a');
            a.className='page-link';a.href='#';a.textContent=text;
            a.addEventListener('click',e=>{e.preventDefault();if(!disabled)onClick();});
            li.appendChild(a);return li;
        }

        function renderChips(total){
            $chips.innerHTML='';
            const defs=[];
            if(state.search) defs.push({k:'search',label:`Tìm: "${state.search}"`});
            if(state.minPrice!=='') defs.push({k:'minPrice',label:`Giá tối thiểu: ₫${Number(state.minPrice).toLocaleString('vi-VN')}`});
            if(state.maxPrice!=='') defs.push({k:'maxPrice',label:`Giá tối đa: ₫${Number(state.maxPrice).toLocaleString('vi-VN')}`});
            if(state.cat) defs.push({k:'cat',label:`Danh mục: ${state.cat}`});
            if(state.brand) defs.push({k:'brand',label:`Thương hiệu: ${state.brand}`});
            if(state.sort!=='default'){
                const map={priceAsc:'Giá ↑',priceDesc:'Giá ↓',nameAsc:'Tên A→Z',nameDesc:'Tên Z→A'};
                defs.push({k:'sort',label:`Sắp xếp: ${map[state.sort]}`});
            }
            if(state.size!==20) defs.push({k:'size',label:`${state.size}/trang`});

            defs.forEach(def=>{
                const b=document.createElement('button');
                b.type='button';b.className='chip chip-dismiss';
                b.innerHTML=`<i class="bi bi-x"></i> ${def.label}`;
                b.addEventListener('click',()=>{
                    if(def.k==='search'){state.search='';$search.value='';}
                    if(def.k==='minPrice'){state.minPrice='';$minPrice.value='';}
                    if(def.k==='maxPrice'){state.maxPrice='';$maxPrice.value='';}
                    if(def.k==='cat'){state.cat='';$cat.value='';}
                    if(def.k==='brand'){state.brand='';$brand.value='';}
                    if(def.k==='sort'){state.sort='default';$sort.value='default';}
                    if(def.k==='size'){state.size=20;$size.value='20';}
                    state.page=1;apply();
                });
                $chips.appendChild(b);
            });

            const hasActiveFilters = state.search || state.minPrice!=='' || state.maxPrice!=='' ||
                                    state.cat || state.brand || state.sort!=='default' || state.size!==20;
            $reset.classList.toggle('d-none', !hasActiveFilters);
            $reset.onclick=()=>{
                state.search='';state.minPrice='';state.maxPrice='';
                state.cat='';state.brand='';state.sort='default';state.size=20;state.page=1;
                $search.value='';$minPrice.value='';$maxPrice.value='';
                $cat.value='';$brand.value='';$sort.value='default';$size.value='20';
                apply();
            };
        }

        // Event listeners
        let searchTimer;
        $search.addEventListener('input',()=>{
            clearTimeout(searchTimer);
            searchTimer = setTimeout(()=>{
                state.search=$search.value.trim();
                state.page=1;
                apply();
            }, 300);
        });

        $minPrice.addEventListener('input',()=>{
            state.minPrice=$minPrice.value.trim();
            state.page=1;
            apply();
        });

        $maxPrice.addEventListener('input',()=>{
            state.maxPrice=$maxPrice.value.trim();
            state.page=1;
            apply();
        });

        $cat.addEventListener('change',()=>{state.cat=$cat.value;state.page=1;apply();});
        $brand.addEventListener('change',()=>{state.brand=$brand.value;state.page=1;apply();});
        $sort.addEventListener('change',()=>{state.sort=$sort.value;state.page=1;apply();});
        $size.addEventListener('change',()=>{state.size=parseInt($size.value,10);state.page=1;apply();});

        apply();
    })();
</script>
</body>
</html>
