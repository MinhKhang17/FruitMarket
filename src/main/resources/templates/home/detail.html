<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${product.productName} + ' — Chi tiết sản phẩm'">Chi tiết sản phẩm</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        body { background: #f8f9fa; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif; color: #222; }
        .card { border-radius: 12px; }
        .img-wrap img { max-height: 480px; object-fit: contain; border-radius: 8px; width:100%; }
        .thumbnail-btn { width:72px; height:72px; padding:0; border:1px solid #e9ecef; border-radius:8px; overflow:hidden; background:#fff; }
        .thumbnail-btn.active { outline: 3px solid rgba(47,158,68,0.15); box-shadow: 0 6px 18px rgba(47,158,68,0.06); }
        .variant-btn { border:1px solid #dee2e6; border-radius:6px; padding:6px 14px; margin:4px 6px 4px 0; cursor:pointer; background:white; transition: all .12s; }
        .variant-btn.active { background: #198754; color:#fff; border-color:#198754; }
        .price-large { font-size: 1.6rem; font-weight:700; color:#198754; }
        .stock-info { font-size:.9rem; color:#6c757d; }
        .btn-view { padding:.5rem 1rem; border-radius:8px; }
        .small-muted { color:#6c757d; }
        @media (max-width:767px) { .img-wrap img { max-height:320px; } }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="page py-4">
    <div class="container" th:object="${product}">

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-4 align-items-start">

                    <!-- LEFT: Main image + thumbnails -->
                    <div class="col-lg-6 text-center">
                        <div class="img-wrap mb-3">
                            <img id="productImage"
                                 th:src="${
                                     (product.productVariants != null and !#lists.isEmpty(product.productVariants)
                                      and product.productVariants.get(0).image != null and product.productVariants.get(0).image.url != null)
                                     ? product.productVariants.get(0).image.url
                                     : (product.imageUrl != null and !#strings.isEmpty(product.imageUrl) ? product.imageUrl : '/images/placeholder.jpg')
                                 }"
                                 th:alt="${product.productName}"
                                 class="img-fluid rounded"
                                 onerror="this.src='/images/placeholder.jpg'"/>
                        </div>

                        <!-- Thumbnails -->
                        <div class="d-flex justify-content-center gap-2 flex-wrap" id="variantThumbnails"
                             th:if="${product.productVariants != null and !#lists.isEmpty(product.productVariants)}">
                            <button type="button"
                                    th:each="v, idx : ${product.productVariants}"
                                    class="thumbnail-btn"
                                    th:classappend="${idx.index == 0} ? ' active' : ''"
                                    th:attr="data-index=${idx.index}, title=${v.variant_name}"
                                    th:onclick="'selectVariantByIndex(' + ${idx.index} + ')'"
                                    aria-label="thumbnail">
                                <img th:src="${v.image != null and v.image.url != null ? v.image.url : '/images/placeholder.png'}"
                                     th:alt="${v.variant_name}"
                                     style="width:100%; height:100%; object-fit:cover;"
                                     onerror="this.src='/images/placeholder.png'"/>
                            </button>
                        </div>
                    </div>
                    <!-- END LEFT -->

                    <!-- RIGHT -->
                    <div class="col-lg-6">
                        <h2 class="mb-2" th:text="${product.productName}">Tên sản phẩm</h2>

                        <!-- Price -->
                        <div class="mb-3">
                            <span id="displayPrice" class="price-large"
                                  th:text="${
                                      (product.productVariants != null and !#lists.isEmpty(product.productVariants))
                                      ? #numbers.formatDecimal(product.productVariants.get(0).price, 0, 'COMMA', 0, 'POINT')
                                      : (product.productPrice != null ? #numbers.formatDecimal(product.productPrice, 0, 'COMMA', 0, 'POINT') : '—')
                                  }">0</span> <small class="small-muted">₫</small>
                        </div>

                        <p class="text-secondary mb-2" th:text="${product.description}">Mô tả ngắn</p>

                        <p class="mb-1"><strong>Danh mục:</strong> <span th:text="${product.categoryName}">Category</span></p>
                        <p class="mb-3"><strong>Thương hiệu:</strong> <span th:text="${product.brandName}">Brand</span></p>

                        <!-- Variant section -->
                        <div class="variant-options mb-3">
                            <div th:if="${product.unit != null and product.unit.name() == 'KILOGRAM'}">
                                <p class="fw-semibold mb-1" style="color:#198754;"><strong>Giá niêm yết theo 1 kg</strong></p>
                            </div>

                            <div th:if="${product.unit == null or product.unit.name() != 'KILOGRAM'}">
                                <label><strong>Chọn loại sản phẩm</strong></label>

                                <div th:if="${product.productVariants == null or #lists.isEmpty(product.productVariants)}" class="text-muted">
                                    Sản phẩm này không có biến thể.
                                </div>

                                <div th:if="${product.productVariants != null and !#lists.isEmpty(product.productVariants)}" id="variantGroup">
                                    <button th:each="v, idx : ${product.productVariants}"
                                            type="button"
                                            class="variant-btn"
                                            th:text="${v.variant_name}"
                                            th:attr="data-id=${v.id},
                                                     data-price=${v.price},
                                                     data-stock=${v.stock},
                                                     data-image=${v.image != null and v.image.url != null ? v.image.url : ''},
                                                     data-index=${idx.index}"
                                            th:classappend="${idx.index == 0} ? ' active' : ''"
                                            th:onclick="'selectVariantByIndex(' + ${idx.index} + ')'">
                                        Variant
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- quantity / weight input -->
                        <div class="mb-3">
                            <!-- KG -->
                            <div th:if="${product.unit != null and product.unit.name() == 'KILOGRAM'}"
                                 class="d-flex align-items-center gap-2 mb-2">
                                <label class="form-label mb-0 me-2">Nhập số kg:</label>
                                <div class="input-group" style="width:180px;">
                                    <input id="weightInput" name="weight" type="number" step="0.1" min="0.1" value="1" class="form-control"/>
                                    <span class="input-group-text">kg</span>
                                </div>
                                <span id="stockHintWeight" class="stock-info ms-2"></span>
                            </div>

                            <!-- NOT KG -->
                            <div th:if="${product.unit == null or product.unit.name() != 'KILOGRAM'}"
                                 class="d-flex align-items-center gap-2 mb-2">
                                <label class="form-label mb-0 me-2">Số lượng:</label>
                                <div class="input-group" style="width:160px;">
                                    <input id="qtyInput" name="quantity" type="number" min="1" value="1" class="form-control"/>
                                    <span class="input-group-text"
                                          th:text="${
                                            product.unit != null ?
                                              (product.unit.name() == 'BASKET' ? 'rổ' :
                                               product.unit.name() == 'PIECE'  ? 'cái' :
                                               product.unit.name().toLowerCase())
                                            : 'cái'
                                          }">cái</span>
                                </div>
                                <span id="stockHintQty" class="stock-info ms-2"></span>
                            </div>

                            <!-- Actions -->
                            <div class="d-flex gap-2 mt-2">
                                <!-- Add to Cart -->
                                <form id="addToCartForm" th:action="@{/cart/add}" method="post" style="display:inline;">
                                    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                                    <!-- variant default: first variant if exists -->
                                    <input type="hidden" id="variantIdInput2" name="variantId"
                                           th:value="${(product.productVariants != null and !#lists.isEmpty(product.productVariants)) ? product.productVariants.get(0).id : ''}" />
                                    <!-- keep alternative name for compatibility -->
                                    <input type="hidden" id="product_variant_id_hidden" name="product_variant_id"
                                           th:value="${(product.productVariants != null and !#lists.isEmpty(product.productVariants)) ? product.productVariants.get(0).id : ''}" />

                                    <input type="hidden" name="productId" th:value="${product.productId}" />

                                    <!-- ALWAYS include hidden fields but we will blank the irrelevant one before submit -->
                                    <input type="hidden" id="qtyInputForAdd" name="quantity" value="" />
                                    <input type="hidden" id="weightInputForAdd" name="weight" value="" />

                                    <button type="submit" class="btn btn-outline-success btn-view">Thêm vào giỏ</button>
                                </form>

                                <!-- Checkout -->
                                <form id="checkoutForm" th:action="@{/checkout}" method="post"
                                      onsubmit="return validateCheckout();" style="display:inline;">
                                    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" />
                                    <!-- name khớp với DTO getProduct_variant_id() -->
                                    <input type="hidden" id="variantIdInput" name="product_variant_id"
                                           th:value="${(product.productVariants != null and !#lists.isEmpty(product.productVariants)) ? product.productVariants.get(0).id : ''}" />
                                    <!-- also keep variantId for server if needed -->
                                    <input type="hidden" id="variantIdInput_checkout_variantId" name="variantId"
                                           th:value="${(product.productVariants != null and !#lists.isEmpty(product.productVariants)) ? product.productVariants.get(0).id : ''}" />

                                    <input type="hidden" name="productId" th:value="${product.productId}" />

                                    <!-- ALWAYS include hidden fields but blank irrelevant before submit -->
                                    <input type="hidden" id="qtyInputForCheckout" name="quantity" value="" />
                                    <input type="hidden" id="weightInputForCheckout" name="weight" value="" />

                                    <button type="submit" class="btn btn-success btn-view">Thanh toán</button>
                                </form>

                                <a class="btn btn-outline-secondary btn-view" th:href="@{/}">Quay lại</a>
                            </div>
                        </div>

                        <div class="mt-3 small text-muted">
                            <div>SKU: <span th:text="${product.productId}">-</span></div>
                        </div>
                    </div>
                    <!-- END RIGHT -->
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Full replacement script: đảm bảo sync qty/weight/variant trước submit -->
<script th:inline="javascript">
    (function () {
        // Elements
        const displayPrice = document.getElementById("displayPrice");
        const productImage = document.getElementById("productImage");

        const qtyInput = document.getElementById("qtyInput"); // may be null for KILOGRAM products
        const weightInput = document.getElementById("weightInput"); // may be null for non-KG

        const variantIdInput = document.getElementById("variantIdInput"); // hidden for checkout (product_variant_id)
        const variantIdInput_checkout_variantId = document.getElementById("variantIdInput_checkout_variantId"); // alt
        const variantIdInput2 = document.getElementById("variantIdInput2"); // hidden for add-to-cart
        const product_variant_id_hidden = document.getElementById("product_variant_id_hidden"); // alt hidden name

        const qtyInputForAdd = document.getElementById("qtyInputForAdd");
        const qtyInputForCheckout = document.getElementById("qtyInputForCheckout");
        const weightInputForAdd = document.getElementById("weightInputForAdd");
        const weightInputForCheckout = document.getElementById("weightInputForCheckout");

        const stockHintQty = document.getElementById("stockHintQty");
        const stockHintWeight = document.getElementById("stockHintWeight");

        // read server-side unit name (fallback PIECE)
        const unit = /*[[${product.unit != null ? product.unit.name() : 'PIECE'}]]*/ 'PIECE';

        // Helpers
        function toNumber(v, def = 0) {
            const n = Number(v);
            return isNaN(n) ? def : n;
        }

        function fmtPrice(v) {
            const n = Number(v);
            if (isNaN(n)) return v;
            return n.toLocaleString("vi-VN");
        }

        // Find active variant element (button)
        function getActiveVariantButton() {
            return document.querySelector('.variant-btn.active') || document.querySelector('.variant-btn[data-index="0"]');
        }
        function getVariantDataFromBtn(btn) {
            if (!btn) return { id: '', price: 0, stock: null, image: null };
            return {
                id: btn.getAttribute('data-id') || '',
                price: toNumber(btn.getAttribute('data-price'), 0),
                stock: btn.getAttribute('data-stock') != null ? toNumber(btn.getAttribute('data-stock'), null) : null,
                image: btn.getAttribute('data-image') || null
            };
        }

        // Update display price using base price and multiplier (qty or weight)
        function updateDisplayPrice(basePrice) {
            const bp = toNumber(basePrice, 0);
            let multiplier = 1;
            if (unit === 'KILOGRAM') {
                multiplier = toNumber(weightInput?.value, 1);
                if (multiplier <= 0) multiplier = 1;
            } else {
                multiplier = Math.floor(Math.max(1, toNumber(qtyInput?.value, 1)));
            }
            const total = bp * multiplier;
            if (displayPrice) displayPrice.textContent = fmtPrice(total);
        }

        // Sync hidden inputs for both forms
        // IMPORTANT: only set 'quantity' when product is non-kg; only set 'weight' when product is kg.
        // Otherwise blank the irrelevant hidden field so backend won't accidentally use it.
        function updateHiddenFields() {
            const activeBtn = getActiveVariantButton();
            const vd = getVariantDataFromBtn(activeBtn);

            // variant ids
            if (variantIdInput) variantIdInput.value = vd.id || '';
            if (variantIdInput_checkout_variantId) variantIdInput_checkout_variantId.value = vd.id || '';
            if (variantIdInput2) variantIdInput2.value = vd.id || '';
            if (product_variant_id_hidden) product_variant_id_hidden.value = vd.id || '';

            if (unit === 'KILOGRAM') {
                // weight is meaningful, quantity should be blank (or 0) to avoid backend mis-interpretation
                const w = Math.max(0.1, toNumber(weightInput?.value, 1));
                if (weightInputForAdd) weightInputForAdd.value = String(Math.round(w * 10) / 10);
                if (weightInputForCheckout) weightInputForCheckout.value = String(Math.round(w * 10) / 10);

                if (qtyInputForAdd) qtyInputForAdd.value = '';
                if (qtyInputForCheckout) qtyInputForCheckout.value = '';
            } else {
                // quantity meaningful, weight blank
                const q = Math.max(1, Math.floor(toNumber(qtyInput?.value, 1)));
                if (qtyInputForAdd) qtyInputForAdd.value = String(q);
                if (qtyInputForCheckout) qtyInputForCheckout.value = String(q);

                if (weightInputForAdd) weightInputForAdd.value = '';
                if (weightInputForCheckout) weightInputForCheckout.value = '';
            }
        }

        // Enforce stock limit and show hints
        function enforceStockLimitsAndHints(vd) {
            const stock = vd && vd.stock != null ? vd.stock : null;
            if (stockHintQty) stockHintQty.textContent = stock != null ? ("(Còn " + stock + " sản phẩm)") : '';
            if (stockHintWeight) stockHintWeight.textContent = stock != null ? ("(Còn " + stock + ")") : '';

            if (qtyInput && stock != null) {
                qtyInput.max = stock;
                if (toNumber(qtyInput.value, 1) > stock) qtyInput.value = String(stock);
            }
        }

        // Select variant by index (exposed globally for thumbnail onclicks)
        window.selectVariantByIndex = function (index) {
            // Find variant btn with data-index === index
            const btn = document.querySelector('.variant-btn[data-index="' + index + '"]');
            if (btn) {
                document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            // Thumbnails
            document.querySelectorAll('#variantThumbnails .thumbnail-btn').forEach(tb => {
                if (tb.getAttribute('data-index') === String(index)) tb.classList.add('active'); else tb.classList.remove('active');
            });

            const active = getActiveVariantButton();
            const vd = getVariantDataFromBtn(active);

            // update image
            if (vd.image && productImage) productImage.src = vd.image;

            // update display price & hidden inputs & stock hints
            updateDisplayPrice(vd.price);
            enforceStockLimitsAndHints(vd);
            updateHiddenFields();
        };

        // Bind variant button clicks
        function bindVariantButtons() {
            document.querySelectorAll('.variant-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const idx = this.getAttribute('data-index');
                    window.selectVariantByIndex(idx);
                });
            });
            // Thumbnails already call selectVariantByIndex via onclick attributes; add click fallback
            document.querySelectorAll('#variantThumbnails .thumbnail-btn').forEach(tb => {
                tb.addEventListener('click', function () {
                    const idx = this.getAttribute('data-index');
                    if (idx != null) window.selectVariantByIndex(idx);
                });
            });
        }

        // Bind qty/weight inputs to live update and validation
        function bindQtyWeightInputs() {
            if (unit === 'KILOGRAM') {
                if (weightInput) {
                    const sync = function () {
                        // prevent invalid values
                        let v = toNumber(weightInput.value, 1);
                        if (v <= 0) v = 1;
                        // keep one decimal at most
                        v = Math.round(v * 10) / 10;
                        weightInput.value = String(v);
                        const active = getActiveVariantButton();
                        const vd = getVariantDataFromBtn(active);
                        updateDisplayPrice(vd.price);
                        updateHiddenFields();
                    };
                    weightInput.addEventListener('input', sync);
                    weightInput.addEventListener('change', sync);
                    sync();
                }
                if (qtyInput) qtyInput.disabled = true;
            } else {
                if (qtyInput) {
                    const sync = function () {
                        let q = Math.floor(Math.max(1, toNumber(qtyInput.value, 1)));
                        if (qtyInput.max) q = Math.min(q, toNumber(qtyInput.max, q));
                        qtyInput.value = String(q);
                        const active = getActiveVariantButton();
                        const vd = getVariantDataFromBtn(active);
                        updateDisplayPrice(vd.price);
                        updateHiddenFields();
                    };
                    qtyInput.addEventListener('input', sync);
                    qtyInput.addEventListener('change', sync);
                    sync();
                }
                if (weightInput) weightInput.disabled = true;
            }
        }

        // Validate before submit (both forms)
        function attachFormValidation() {
            const addForm = document.getElementById('addToCartForm');
            const checkoutForm = document.getElementById('checkoutForm');

            const preSubmit = function (e, forCheckout) {
                // Ensure we sync just before submit
                updateHiddenFields();

                // Ensure variant selected if variants exist
                const hasVariants = document.querySelectorAll('.variant-btn').length > 0;
                const vid = (forCheckout ? (variantIdInput?.value || variantIdInput_checkout_variantId?.value) : (variantIdInput2?.value || product_variant_id_hidden?.value));
                if (hasVariants && (!vid || vid === '')) {
                    e.preventDefault();
                    alert('Vui lòng chọn biến thể sản phẩm trước khi tiếp tục.');
                    return false;
                }

                if (unit === 'KILOGRAM') {
                    const w = toNumber(weightInput?.value, 0);
                    if (w <= 0) { e.preventDefault(); alert('Số kg không hợp lệ!'); return false; }
                } else {
                    const q = Math.floor(toNumber(qtyInput?.value, 0));
                    if (q <= 0) { e.preventDefault(); alert('Số lượng không hợp lệ!'); return false; }
                    if (qtyInput && qtyInput.max && q > toNumber(qtyInput.max, q)) { e.preventDefault(); alert('Số lượng vượt quá tồn kho!'); return false; }
                }

                // All good — hidden fields already synced
                return true;
            };

            if (addForm) addForm.addEventListener('submit', function (e) { preSubmit(e, false); });
            if (checkoutForm) checkoutForm.addEventListener('submit', function (e) { preSubmit(e, true); });
        }

        // INIT on DOM ready
        document.addEventListener('DOMContentLoaded', function () {
            bindVariantButtons();
            bindQtyWeightInputs();

            // default select first variant if exists
            const firstVariantBtn = document.querySelector('.variant-btn[data-index="0"]');
            if (firstVariantBtn) {
                window.selectVariantByIndex(0);
            } else {
                // no variant buttons: try to set price from server-rendered displayPrice and sync hidden fields
                updateHiddenFields();
            }

            attachFormValidation();
        });

        // expose helpers for debug
        window.__fm_syncHidden = updateHiddenFields;
        window.__fm_selectVariantByIndex = window.selectVariantByIndex;
    })();
</script>

</body>
</html>
