<!-- file: src/main/resources/templates/user/ordersClient.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i | FruitMarket</title>
    <link th:href="@{/header.css}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --brand:#198754;
            --soft:#f5f8f6;
        }
        body { background:var(--soft); }
        .orders-wrap { max-width:1100px; margin:auto; }
        .toolbar {
            background:#fff; border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.06);
            padding:14px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
        }
        .order-card {
            border:none; border-radius:16px; overflow:hidden;
            box-shadow:0 10px 22px rgba(0,0,0,.08); transition:transform .18s ease, box-shadow .18s ease;
        }
        .order-card:hover { transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.12); }
        .order-head {
            background:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
            border-bottom:1px solid #eef1ef;
        }
        .order-id { font-weight:700; color:#333; }
        .status-badge {
            padding: .4rem .75rem;
            border-radius: .65rem;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-image: linear-gradient(to bottom right, rgba(255,255,255,0.15), rgba(0,0,0,0.05));
        }

        /* CH·ªú X·ª¨ L√ù */
        .status-PENDING {
            background: #ffe082;
            color: #5c4400;
            border-color: #ffd54f;
        }

        /* HO√ÄN T·∫§T */
        .status-COMPLETED {
            background: #81c784;
            color: #0a3d18;
            border-color: #66bb6a;
        }

        /* HU·ª∂ ƒê∆†N (CANCELLED ho·∫∑c CANCELED) */
        .status-CANCELED,
        .status-CANCELLED {
            background: #ef9a9a;
            color: #5a0000;
            border-color: #e57373;
        }

        /* ƒêANG GIAO */
        .status-SHIPPING {
            background: #4fc3f7;
            color: #013d57;
            border-color: #29b6f6;
        }

        /* ƒê√É G·ª¨I / ƒê√É NH·∫¨N */
        .status-SHIPPED {
            background: #bdbdbd;
            color: #212121;
            border-color: #9e9e9e;
        }

        .order-body { padding:14px 16px; background:#fff; }
        .mini-info { color:#6c757d; font-size:.95rem; display:flex; align-items:center; gap:.5rem; }
        .mini-info i { color:var(--brand); }
        .items-table th, .items-table td { vertical-align:middle; }
        .items-table th { color:#6c757d; font-weight:600; }
        .total-line {
            display:flex; justify-content:flex-end; gap:24px; align-items:center;
            padding-top:10px; border-top:1px dashed #e6ece8; margin-top:6px;
        }
        .total-amount { color:var(--brand); font-weight:700; font-size:1.1rem; }
        .empty {
            background:#fff; border-radius:16px; padding:48px 16px; text-align:center;
            box-shadow:0 10px 20px rgba(0,0,0,.06);
        }
        .filter-btn {
            border-radius:999px; padding:6px 14px; border:1px solid #e6ece8; background:#fff;
        }
        .filter-btn.active, .filter-btn:hover { background:var(--brand); color:#fff; border-color:var(--brand); }
        .pay-chip { background:#eef8f1; color:#2b7f53; border-radius:999px; padding:4px 10px; font-size:.85rem; }

        /* CSS cho th√¥ng b√°o ho√†n ti·ªÅn */
        .refund-alert {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 1rem;
        }
        .refund-alert i {
            color: #1976d2;
        }
        .refund-alert strong {
            color: #0d47a1;
        }
        .ship-line,
        .total-line {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 24px;
            padding-top: 6px;
            margin-top: 4px;
        }

        /* Ph√≠ v·∫≠n chuy·ªÉn */
        .ship-line {
            color: #198754;
        }

        .ship-line .text-muted {
            color: #6c757d !important;
            font-weight: 500;
        }

        .ship-amount {
            font-weight: 600;
            color: #198754;
        }

        /* T·ªïng thanh to√°n */
        .total-line {
            border-top: 1px dashed #e6ece8;
            margin-top: 6px;
            padding-top: 8px;
        }

        .total-amount {
            color: #198754;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* === Style cho kh·ªëi (.block) ‚Äî phi√™n b·∫£n "ƒë√≥ng khung ph·∫≥ng" === */
        .block {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 14px;
            padding: 16px 18px;
        }

        .block .section-title {
            font-weight: 700;
            font-size: 1.05rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: .5rem;
            color: #198754;
        }

        .block .section-title::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #198754;
        }

        .block .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: .95rem;
            border-top: 1px dashed #e9ecef;
        }

        .block .total-row:first-of-type {
            border-top: none;
        }

        .block .divider {
            height: 1px;
            background: #e9ecef;
            margin: 10px 0;
        }

        .block .grand {
            font-weight: 700;
            color: #198754;
        }

        .block .mini-info {
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: 6px 0;
            border-top: 1px dashed #e9ecef;
        }

        .block .mini-info:first-of-type {
            border-top: none;
        }
        /* === H·∫øt ph·∫ßn th√™m === */
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container py-4 orders-wrap">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h3 class="mb-2 mb-md-0 text-success"><i class="bi bi-basket2-fill me-2"></i>ƒê∆°n h√†ng c·ªßa t√¥i</h3>
        <!-- Toolbar l·ªçc -->
        <div class="toolbar" role="toolbar" aria-label="B·ªô l·ªçc ƒë∆°n h√†ng">
            <button type="button" class="filter-btn active" data-filter="ALL" tabindex="0">
                <i class="bi bi-ui-checks-grid me-1"></i>T·∫•t c·∫£
            </button>
            <button type="button" class="filter-btn" data-filter="PENDING" tabindex="0">
                <i class="bi bi-hourglass-split me-1"></i>Ch·ªù x·ª≠ l√Ω
            </button>
            <button type="button" class="filter-btn" data-filter="COMPLETED" tabindex="0">
                <i class="bi bi-check2-circle me-1"></i>Ho√†n t·∫•t
            </button>
            <button type="button" class="filter-btn" data-filter="CANCELED" tabindex="0">
                <i class="bi bi-x-circle me-1"></i>ƒê√£ h·ªßy
            </button>
        </div>
    </div>

    <!-- Empty state -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty my-4">
        <i class="bi bi-clipboard-x" style="font-size:3rem;color:#a8b5ae"></i>
        <h5 class="mt-3 mb-1">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h5>
        <p class="text-muted mb-3">B·∫Øt ƒë·∫ßu mua s·∫Øm ƒë·ªÉ th·∫•y ƒë∆°n h√†ng xu·∫•t hi·ªán t·∫°i ƒë√¢y.</p>
        <a th:href="@{/products}" class="btn btn-success"><i class="bi bi-bag"></i> Mua s·∫Øm ngay</a>
    </div>

    <!-- Danh s√°ch ƒë∆°n -->
    <div class="row g-4" th:if="${!#lists.isEmpty(orders)}">
        <div class="col-12" th:each="o : ${orders}">
            <!-- ƒê·∫∑t data-status theo ENUM.NAME() ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ kho·∫£ng tr·∫Øng/l·ªách ch√≠nh t·∫£ -->
            <div class="card order-card" th:attr="data-status=${o.orderStauts != null ? o.orderStauts.name() : ''}">
                <!-- Header -->
                <div class="order-head">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <span class="order-id">#<span th:text="${o.id}">1001</span></span>
                        <span class="pay-chip" title="Ph∆∞∆°ng th·ª©c thanh to√°n" th:text="${o.pricingMethod}">COD</span>
                        <small class="text-muted">SL:
                            <strong th:text="${o.totalQuantity}">1</strong>
                        </small>
                    </div>
                    <span class="badge status-badge"
                          th:classappend="'status-' + ${o.orderStauts}"
                          th:text="${o.orderStauts}">PENDING</span>
                </div>

                <!-- Body -->
                <div class="order-body">
                    <div class="row">
                        <div class="col-lg-7">
                            <!-- üî≤ ƒê√ìNG KHUNG B·∫¢NG S·∫¢N PH·∫®M -->
                            <div class="block mb-3">
                                <div class="section-title">S·∫£n ph·∫©m</div>
                                <table class="table table-sm items-table align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width:40%">S·∫£n ph·∫©m</th>
                                        <th class="text-center" style="width:15%">ƒê∆°n v·ªã</th>
                                        <th class="text-center" style="width:15%">SL/Kh·ªëi l∆∞·ª£ng</th>
                                        <th class="text-end" style="width:15%">ƒê∆°n gi√°</th>
                                        <th class="text-end" style="width:15%">Th√†nh ti·ªÅn</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="item : ${o.orderItemList}">
                                        <td>
                                            <div class="fw-semibold"
                                                 th:text="${item.productVariant.product.productName}">T√™n s·∫£n ph·∫©m</div>
                                            <div class="text-muted small"
                                                 th:if="${item.productVariant.variant_name != null}"
                                                 th:text="${item.productVariant.variant_name}">Ph√¢n lo·∫°i</div>
                                        </td>

                                        <td class="text-center"
                                            th:text="${item != null && item.unit != null && item.unit.toString() == 'KILOGRAM' ? 'Kg' : 'C√°i'}">
                                            PIECE
                                        </td>

                                        <td class="text-center"
                                            th:text="${item != null ?
                                                        (item.unit != null && item.unit.toString() == 'KILOGRAM'
                                                          ? (item.weight != null ? item.weight + ' kg' : '0 kg')
                                                          : (item.quantity != null ? item.quantity : 0)
                                                        )
                                                        : 'N/A'}">1
                                        </td>

                                        <td class="text-end">
                                            <span th:text="${#numbers.formatDecimal(
                                              (item.price != null ? item.price : item.productVariant.price),
                                              0,'POINT',0,'COMMA')}">120000</span>ƒë
                                        </td>

                                        <!-- ‚úÖ C·ªòT M·ªöI: Th√†nh ti·ªÅn -->
                                        <td class="text-end fw-semibold text-success">
                                            <span th:text="${#numbers.formatDecimal(
                                              (
                                                (item.unit != null && item.unit.toString() == 'KILOGRAM')
                                                  ? (item.weight != null ? item.price * item.weight : 0)
                                                  : (item.quantity != null ? item.price * item.quantity : 0)
                                              ),
                                              0,'POINT',0,'COMMA')}">120000</span>ƒë
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- /block b·∫£ng s·∫£n ph·∫©m -->
                        </div>
                        <div class="col-lg-5">

                            <!-- üßç Th√¥ng tin nh·∫≠n h√†ng (ƒê√É ƒê√ìNG KH·ªêI) -->
                            <div class="block mb-3">
                                <div class="section-title">Th√¥ng tin nh·∫≠n h√†ng</div>

                                <!-- üè† ƒê·ªãa ch·ªâ -->
                                <div class="mini-info">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span th:text="${o.address}">123 L√™ L·ª£i, Q.1</span>
                                </div>

                                <!-- ‚òéÔ∏è S·ªë ƒëi·ªán tho·∫°i -->
                                <div class="mini-info">
                                    <i class="bi bi-telephone me-2"></i>
                                    <span th:text="${o.phoneNumber}">0901234567</span>
                                </div>

                                <!-- üë§ Ng∆∞·ªùi nh·∫≠n -->
                                <div class="mini-info">
                                    <i class="bi bi-person me-1"></i>
                                    <span class="text-muted">Ng∆∞·ªùi nh·∫≠n:</span>
                                    <span class="fw-semibold" th:text="${o.recipientName}">Kh√°ch h√†ng</span>
                                </div>
                            </div>

                            <!-- ‚úÖ Th√¥ng tin GHN -->
                            <div class="block mb-3"
                                 th:with="fee=${o.shippingFee != null ? o.shippingFee : 0},
                                            goods=${(o.totalPrice != null ? o.totalPrice : 0) - fee}">

                                <div class="section-title">T·ªïng thanh to√°n</div>

                                <div class="total-row">
                                    <span class="text-muted">T·ªïng ti·ªÅn h√†ng</span>
                                    <span>
                                        <span th:text="${#numbers.formatDecimal(goods,0,'POINT',0,'COMMA')}">0</span>ƒë
                                    </span>
                                </div>

                                <div class="total-row">
                                    <span class="text-muted">Ph√≠ v·∫≠n chuy·ªÉn</span>
                                    <span>
                                        <span th:text="${#numbers.formatDecimal(fee,0,'POINT',0,'COMMA')}">0</span>ƒë
                                    </span>
                                </div>

                                <div class="divider"></div>

                                <div class="total-row">
                                    <span class="fw-semibold">Th√†nh ti·ªÅn</span>
                                    <span class="grand">
                                        <span th:text="${#numbers.formatDecimal(o.totalPrice,0,'POINT',0,'COMMA')}">0</span>ƒë
                                    </span>
                                </div>

                                <!-- üßæ H√†nh ƒë·ªông -->
                                <div class="d-flex justify-content-end align-items-center gap-2 mt-3">

                                    <!-- Hu·ª∑ ƒë∆°n -->
                                    <form th:if="${o.orderStauts == T(com.example.fruitmarket.enums.OrderStauts).PENDING
                                                    or o.ghnStatus == T(com.example.fruitmarket.enums.GhnStatus).READY_TO_PICK
                                                    or o.ghnStatus == T(com.example.fruitmarket.enums.GhnStatus).PICKING}"
                                          th:action="@{|/orders/${o.id}/cancel|}" method="post"
                                          class="m-0"
                                          th:attr="onsubmit=|return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën hu·ª∑ ƒë∆°n #${o.id}?');|">
                                        <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-x-circle"></i> Hu·ª∑ ƒë∆°n
                                        </button>
                                    </form>

                                    <!-- Chi ti·∫øt -->
                                    <a class="btn btn-outline-success btn-sm" th:href="@{'/myOrders/' + ${o.id}}">
                                        <i class="bi bi-receipt"></i> Chi ti·∫øt
                                    </a>
                                </div>
                            </div>
                            <!-- /block t·ªïng thanh to√°n -->

                            <!-- ‚úÖ TH√îNG TIN GHN & TR·∫†NG TH√ÅI -->
                            <div class="mini-info mb-2" th:if="${o.ghnOrderCode != null}">
                                <i class="bi bi-truck me-1 text-success"></i>
                                <span>ƒê∆°n GHN:</span>
                                <span class="fw-semibold text-success" th:text="${o.ghnOrderCode}">GHN123456</span>
                            </div>
                            <div class="mini-info mb-3" th:if="${o.ghnStatus != null}">
                                <i class="bi bi-box-seam me-1 text-success"></i>
                                <span>Tr·∫°ng th√°i GHN:</span>
                                <span th:text="${o.ghnStatus}">delivering</span>
                            </div>

                            <!-- ‚úÖ TH√îNG TIN HO√ÄN TI·ªÄN -->
                            <div class="refund-alert d-flex align-items-center"
                                 th:if="${o.orderStauts != null && o.orderStauts.name() == 'CANCELLED' && o.refundPayment != null}">
                                <i class="bi bi-cash-coin me-2" style="font-size: 1.5rem;"></i>
                                <div class="flex-grow-1">
                                    <strong>ƒê√£ ƒë∆∞·ª£c ho√†n ti·ªÅn</strong>
                                    <div class="small text-muted mt-1">
                                        S·ªë ti·ªÅn:
                                        <span class="fw-semibold text-primary"
                                              th:text="${#numbers.formatDecimal(o.refundPayment.amount, 0, 'POINT', 0, 'COMMA')}">0</span>ƒë
                                    </div>
                                    <div class="small text-muted" th:if="${o.refundPayment.paymentDate != null}">
                                        Ng√†y ho√†n:
                                        <span th:text="${#temporals.format(o.refundPayment.paymentDate, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                                    </div>
                                    <div class="small text-muted" th:if="${o.refundPayment.transactionId != null}">
                                        M√£ tham chi·∫øu:
                                        <span class="fw-semibold" th:text="${o.refundPayment.transactionId}">REF123456</span>
                                    </div>
                                </div>
                            </div>
                            <!-- ‚úÖ K·∫æT TH√öC HO√ÄN TI·ªÄN -->

                        </div>
                    </div>
                </div>
                <!-- /order-body -->
            </div>
        </div>
    </div>

</div>
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Notification (ƒë·∫∑t d∆∞·ªõi footer ƒë·ªÉ th√¥ng b√°o hi·ªÉn th·ªã ƒë√∫ng z-index n·∫øu c·∫ßn) -->
<div th:replace="~{fragments/notification :: notification}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function () {
        // L·∫•y toolbar, n√∫t v√† th·∫ª card
        const toolbar = document.querySelector('.toolbar');
        const buttons = Array.from(document.querySelectorAll('.filter-btn'));
        const cards   = Array.from(document.querySelectorAll('[data-status]'));

        // Chu·∫©n ho√° gi√° tr·ªã status
        function norm(s) {
            s = (s || '').toUpperCase().trim();
            if (s === 'CANCELLED') s = 'CANCELED'; // ƒë·ªìng b·ªô 2 c√°ch vi·∫øt
            return s;
        }
        const isEqual = (a, b) => norm(a) === norm(b);

        // √Åp filter
        function applyFilter(status) {
            const target = norm(status);
            cards.forEach(c => {
                const s = c.getAttribute('data-status');
                const show = (target === 'ALL') || isEqual(s, target);
                c.style.display = show ? '' : 'none';
            });
        }

        // Set n√∫t active
        function setActive(btn) {
            buttons.forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
        }

        // Delegation: click trong .toolbar
        if (toolbar) {
            toolbar.addEventListener('click', (e) => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;
                e.preventDefault();
                setActive(btn);
                applyFilter(btn.getAttribute('data-filter'));
            });
        }

        // H·ªó tr·ª£ b√†n ph√≠m (Enter/Space)
        buttons.forEach(btn => {
            btn.setAttribute('role', 'button');
            btn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    btn.click();
                }
            });
        });

        // Kh·ªüi t·∫°o tr·∫°ng th√°i: n·∫øu c√≥ ƒë∆°n COMPLETED th√¨ ch·ªçn COMPLETED, ng∆∞·ª£c l·∫°i ALL
        const hasCompleted = cards.some(c => isEqual(c.getAttribute('data-status'), 'COMPLETED'));
        const initial = hasCompleted ? 'COMPLETED' : 'ALL';
        const initBtn = document.querySelector(`.filter-btn[data-filter="${initial}"]`);
        setActive(initBtn);
        applyFilter(initial);

        // small accessibility: allow filter via keyboard arrows (left/right)
        let focusedIndex = buttons.findIndex(b => b.classList.contains('active'));
        if (focusedIndex < 0) focusedIndex = 0;
        buttons.forEach((btn, idx) => {
            btn.addEventListener('focus', () => focusedIndex = idx);
            btn.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight') {
                    const next = (idx + 1) % buttons.length;
                    buttons[next].focus();
                } else if (e.key === 'ArrowLeft') {
                    const prev = (idx - 1 + buttons.length) % buttons.length;
                    buttons[prev].focus();
                }
            });
        });
    })();
</script>
</body>
</html>
