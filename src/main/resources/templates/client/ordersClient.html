<!-- file: src/main/resources/templates/user/ordersClient.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đơn hàng của tôi | FruitMarket</title>
    <link th:href="@{/header.css}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --brand:#198754;
            --soft:#f5f8f6;
        }
        body { background:var(--soft); }
        .orders-wrap { max-width:1100px; margin:auto; }
        .toolbar {
            background:#fff; border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.06);
            padding:14px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
        }
        .order-card {
            border:none; border-radius:16px; overflow:hidden;
            box-shadow:0 10px 22px rgba(0,0,0,.08); transition:transform .18s ease, box-shadow .18s ease;
        }
        .order-card:hover { transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.12); }
        .order-head {
            background:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
            border-bottom:1px solid #eef1ef;
        }
        .order-id { font-weight:700; color:#333; }
        .status-badge { font-size:.85rem; }
        .status-PENDING { background:#fff3cd; color:#9a7b00; }
        .status-COMPLETED { background:#d1e7dd; color:#0f5132; }
        .status-CANCELED { background:#f8d7da; color:#842029; }
        .order-body { padding:14px 16px; background:#fff; }
        .mini-info { color:#6c757d; font-size:.95rem; }
        .mini-info i { color:var(--brand); }
        .items-table th, .items-table td { vertical-align:middle; }
        .items-table th { color:#6c757d; font-weight:600; }
        .total-line {
            display:flex; justify-content:flex-end; gap:24px; align-items:center;
            padding-top:10px; border-top:1px dashed #e6ece8; margin-top:6px;
        }
        .total-amount { color:var(--brand); font-weight:700; font-size:1.1rem; }
        .empty {
            background:#fff; border-radius:16px; padding:48px 16px; text-align:center;
            box-shadow:0 10px 20px rgba(0,0,0,.06);
        }
        .filter-btn {
            border-radius:999px; padding:6px 14px; border:1px solid #e6ece8; background:#fff;
        }
        .filter-btn.active, .filter-btn:hover { background:var(--brand); color:#fff; border-color:var(--brand); }
        .pay-chip { background:#eef8f1; color:#2b7f53; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container py-4 orders-wrap">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h3 class="mb-2 mb-md-0 text-success"><i class="bi bi-basket2-fill me-2"></i>Đơn hàng của tôi</h3>
        <!-- Toolbar lọc -->
        <div class="toolbar">
            <button class="filter-btn active" data-filter="ALL"><i class="bi bi-ui-checks-grid me-1"></i>Tất cả</button>
            <button class="filter-btn" data-filter="PENDING"><i class="bi bi-hourglass-split me-1"></i>Chờ xử lý</button>
            <button class="filter-btn" data-filter="COMPLETED"><i class="bi bi-check2-circle me-1"></i>Hoàn tất</button>
            <button class="filter-btn" data-filter="CANCELED"><i class="bi bi-x-circle me-1"></i>Đã hủy</button>
        </div>
    </div>

    <!-- Empty state -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty my-4">
        <i class="bi bi-clipboard-x" style="font-size:3rem;color:#a8b5ae"></i>
        <h5 class="mt-3 mb-1">Bạn chưa có đơn hàng nào</h5>
        <p class="text-muted mb-3">Bắt đầu mua sắm để thấy đơn hàng xuất hiện tại đây.</p>
        <a th:href="@{/products}" class="btn btn-success"><i class="bi bi-bag"></i> Mua sắm ngay</a>
    </div>

    <!-- Danh sách đơn -->
    <div class="row g-4" th:if="${!#lists.isEmpty(orders)}">
        <div class="col-12" th:each="o : ${orders}">
            <div class="card order-card" th:attr="data-status=${o.orderStauts}">
                <!-- Header -->
                <div class="order-head">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <span class="order-id">#<span th:text="${o.id}">1001</span></span>
                        <span class="pay-chip" title="Phương thức thanh toán" th:text="${o.pricingMethod}">COD</span>
                        <small class="text-muted">SL:
                            <strong th:text="${o.totalQuantity}">1</strong>
                        </small>
                    </div>
                    <span class="badge status-badge"
                          th:classappend="'status-' + ${o.orderStauts}"
                          th:text="${o.orderStauts}">PENDING</span>
                </div>

                <!-- Body -->
                <div class="order-body">
                    <div class="row">
                        <div class="col-lg-7">
                            <table class="table table-sm items-table">
                                <thead>
                                <tr>
                                    <th style="width:50%">Sản phẩm</th>
                                    <th class="text-center" style="width:20%">Đơn vị</th>
                                    <th class="text-center" style="width:15%">SL/Khối lượng</th>
                                    <th class="text-end" style="width:15%">Đơn giá</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="item : ${o.orderItemList}">
                                    <td>
                                        <div class="fw-semibold"
                                             th:text="${item.productVariant.product.productName}">Tên sản phẩm</div>
                                        <div class="text-muted small"
                                             th:if="${item.productVariant.variant_name != null}"
                                             th:text="${item.productVariant.variant_name}">Phân loại</div>
                                    </td>
                                    <td class="text-center"
                                        th:text="${item != null && item.unit != null && item.unit.toString() == 'KILOGRAM' ? 'Kg' : 'Cái'}">
                                        PIECE
                                    </td>

                                    <td class="text-center"
                                        th:text="${item != null ?
        (item.unit != null && item.unit.toString() == 'KILOGRAM'
            ? (item.weight != null ? item.weight + ' kg' : '0 kg')
            : (item.quantity != null ? item.quantity : 0)
        )
        : 'N/A'}">
                                        1
                                    </td>

                                    <td class="text-end">
                                        <span th:text="${#numbers.formatDecimal(
                                            (item.price != null ? item.price : item.productVariant.price),
                                            0,'POINT',0,'COMMA')}">120000</span>đ
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-5">
                            <div class="mini-info mb-2">
                                <i class="bi bi-geo-alt me-1"></i>
                                <span th:text="${o.address}">123 Lê Lợi, Q.1</span>
                            </div>
                            <div class="mini-info mb-3">
                                <i class="bi bi-telephone me-1"></i>
                                <span th:text="${o.phoneNumber}">0901234567</span>
                            </div>

                            <!-- ✅ Thông tin GHN -->
                            <div class="mini-info mb-2" th:if="${o.ghnOrderCode != null}">
                                <i class="bi bi-truck me-1 text-success"></i>
                                <span>Đơn GHN:</span>
                                <span class="fw-semibold text-success" th:text="${o.ghnOrderCode}">GHN123456</span>
                            </div>
                            <div class="mini-info mb-3" th:if="${o.ghnStatus != null}">
                                <i class="bi bi-box-seam me-1 text-success"></i>
                                <span>Trạng thái GHN:</span>
                                <span th:text="${o.ghnStatus}">delivering</span>
                            </div>
                            <!-- ✅ Kết thúc phần GHN -->

                            <div class="total-line">
                                <div class="text-muted">Tổng thanh toán:</div>
                                <div class="total-amount">
                                    <span th:text="${#numbers.formatDecimal(o.totalPrice,0,'POINT',0,'COMMA')}">0</span>đ
                                </div>
                            </div>
                            <!-- Hành động -->
                            <div class="text-end mt-3">
                                <a class="btn btn-outline-success btn-sm" th:href="@{'/myOrders/' + ${o.id}}">
                                    <i class="bi bi-receipt-cutoff"></i> Chi tiết
                                </a>
                                <button class="btn btn-success btn-sm" th:if="${o.orderStauts?.name() == 'PENDING'}">
                                    <i class="bi bi-cash-coin"></i> Thanh toán lại
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Filter by status (front-end)
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('[data-status]');
    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const status = btn.getAttribute('data-filter');
            cards.forEach(c => {
                const s = c.getAttribute('data-status');
                c.style.display = (status === 'ALL' || s === status) ? '' : 'none';
            });
        });
    });
</script>
</body>
</html>
