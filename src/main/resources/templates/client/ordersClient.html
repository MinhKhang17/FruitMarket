<!-- file: src/main/resources/templates/user/ordersClient.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i | FruitMarket</title>
    <link th:href="@{/header.css}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --brand:#198754;
            --soft:#f5f8f6;
        }
        body { background:var(--soft); }
        .orders-wrap { max-width:1100px; margin:auto; }
        .toolbar {
            background:#fff; border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.06);
            padding:14px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
        }
        .order-card {
            border:none; border-radius:16px; overflow:hidden;
            box-shadow:0 10px 22px rgba(0,0,0,.08); transition:transform .18s ease, box-shadow .18s ease;
        }
        .order-card:hover { transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.12); }
        .order-head {
            background:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
            border-bottom:1px solid #eef1ef;
        }
        .order-id { font-weight:700; color:#333; }
        .status-badge {
            padding: .4rem .75rem;
            border-radius: .65rem;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-image: linear-gradient(to bottom right, rgba(255,255,255,0.15), rgba(0,0,0,0.05));
        }

        /* CH·ªú X·ª¨ L√ù */
        .status-PENDING {
            background: #ffe082;        /* v√†ng ƒë·∫≠m h∆°n */
            color: #5c4400;
            border-color: #ffd54f;
        }

        /* HO√ÄN T·∫§T */
        .status-COMPLETED {
            background: #81c784;        /* xanh l√° ƒë·∫≠m h∆°n */
            color: #0a3d18;
            border-color: #66bb6a;
        }

        /* HU·ª∂ ƒê∆†N (CANCELLED ho·∫∑c CANCELED) */
        .status-CANCELED,
        .status-CANCELLED {
            background: #ef9a9a;        /* ƒë·ªè nh·∫°t ƒë·∫≠m h∆°n */
            color: #5a0000;
            border-color: #e57373;
        }

        /* ƒêANG GIAO (tu·ª≥ n·∫øu c√≥ th√™m) */
        .status-SHIPPING {
            background: #4fc3f7;
            color: #013d57;
            border-color: #29b6f6;
        }

        /* ƒê√É G·ª¨I / ƒê√É NH·∫¨N */
        .status-SHIPPED {
            background: #bdbdbd;
            color: #212121;
            border-color: #9e9e9e;
        }

        .order-body { padding:14px 16px; background:#fff; }
        .mini-info { color:#6c757d; font-size:.95rem; }
        .mini-info i { color:var(--brand); }
        .items-table th, .items-table td { vertical-align:middle; }
        .items-table th { color:#6c757d; font-weight:600; }
        .total-line {
            display:flex; justify-content:flex-end; gap:24px; align-items:center;
            padding-top:10px; border-top:1px dashed #e6ece8; margin-top:6px;
        }
        .total-amount { color:var(--brand); font-weight:700; font-size:1.1rem; }
        .empty {
            background:#fff; border-radius:16px; padding:48px 16px; text-align:center;
            box-shadow:0 10px 20px rgba(0,0,0,.06);
        }
        .filter-btn {
            border-radius:999px; padding:6px 14px; border:1px solid #e6ece8; background:#fff;
        }
        .filter-btn.active, .filter-btn:hover { background:var(--brand); color:#fff; border-color:var(--brand); }
        .pay-chip { background:#eef8f1; color:#2b7f53; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container py-4 orders-wrap">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h3 class="mb-2 mb-md-0 text-success"><i class="bi bi-basket2-fill me-2"></i>ƒê∆°n h√†ng c·ªßa t√¥i</h3>
        <!-- Toolbar l·ªçc -->
        <div class="toolbar">
            <button class="filter-btn active" data-filter="ALL"><i class="bi bi-ui-checks-grid me-1"></i>T·∫•t c·∫£</button>
            <button class="filter-btn" data-filter="PENDING"><i class="bi bi-hourglass-split me-1"></i>Ch·ªù x·ª≠ l√Ω</button>
            <button class="filter-btn" data-filter="COMPLETED"><i class="bi bi-check2-circle me-1"></i>Ho√†n t·∫•t</button>
            <button class="filter-btn" data-filter="CANCELED"><i class="bi bi-x-circle me-1"></i>ƒê√£ h·ªßy</button>
        </div>
    </div>

    <!-- Empty state -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty my-4">
        <i class="bi bi-clipboard-x" style="font-size:3rem;color:#a8b5ae"></i>
        <h5 class="mt-3 mb-1">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h5>
        <p class="text-muted mb-3">B·∫Øt ƒë·∫ßu mua s·∫Øm ƒë·ªÉ th·∫•y ƒë∆°n h√†ng xu·∫•t hi·ªán t·∫°i ƒë√¢y.</p>
        <a th:href="@{/products}" class="btn btn-success"><i class="bi bi-bag"></i> Mua s·∫Øm ngay</a>
    </div>

    <!-- Danh s√°ch ƒë∆°n -->
    <div class="row g-4" th:if="${!#lists.isEmpty(orders)}">
        <div class="col-12" th:each="o : ${orders}">
            <!-- ƒê·∫∑t data-status theo ENUM.NAME() ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ kho·∫£ng tr·∫Øng/l·ªách ch√≠nh t·∫£ -->
            <div class="card order-card" th:attr="data-status=${o.orderStauts != null ? o.orderStauts.name() : ''}">
                <!-- Header -->
                <div class="order-head">
                    <div class="d-flex flex-wrap align-items-center gap-3">
                        <span class="order-id">#<span th:text="${o.id}">1001</span></span>
                        <span class="pay-chip" title="Ph∆∞∆°ng th·ª©c thanh to√°n" th:text="${o.pricingMethod}">COD</span>
                        <small class="text-muted">SL:
                            <strong th:text="${o.totalQuantity}">1</strong>
                        </small>
                    </div>
                    <span class="badge status-badge"
                          th:classappend="'status-' + ${o.orderStauts}"
                          th:text="${o.orderStauts}">PENDING</span>
                </div>

                <!-- Body -->
                <div class="order-body">
                    <div class="row">
                        <div class="col-lg-7">
                            <table class="table table-sm items-table">
                                <thead>
                                <tr>
                                    <th style="width:50%">S·∫£n ph·∫©m</th>
                                    <th class="text-center" style="width:20%">ƒê∆°n v·ªã</th>
                                    <th class="text-center" style="width:15%">SL/Kh·ªëi l∆∞·ª£ng</th>
                                    <th class="text-end" style="width:15%">ƒê∆°n gi√°</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="item : ${o.orderItemList}">
                                    <td>
                                        <div class="fw-semibold"
                                             th:text="${item.productVariant.product.productName}">T√™n s·∫£n ph·∫©m</div>
                                        <div class="text-muted small"
                                             th:if="${item.productVariant.variant_name != null}"
                                             th:text="${item.productVariant.variant_name}">Ph√¢n lo·∫°i</div>
                                    </td>
                                    <td class="text-center" th:text="${item.unit}">PIECE</td>
                                    <td class="text-center"
                                        th:text="${item.unit == 'KILOGRAM' ? item.weight + ' kg' : item.quantity}">1</td>
                                    <td class="text-end">
                                        <span th:text="${#numbers.formatDecimal(
                                            (item.price != null ? item.price : item.productVariant.price),
                                            0,'POINT',0,'COMMA')}">120000</span>ƒë
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-lg-5">
                            <div class="mini-info mb-2">
                                <i class="bi bi-geo-alt me-1"></i>
                                <span th:text="${o.address}">123 L√™ L·ª£i, Q.1</span>
                            </div>
                            <div class="mini-info mb-3">
                                <i class="bi bi-telephone me-1"></i>
                                <span th:text="${o.phoneNumber}">0901234567</span>
                            </div>

                            <!-- ‚úÖ Th√¥ng tin GHN -->
                            <div class="mini-info mb-2" th:if="${o.ghnOrderCode != null}">
                                <i class="bi bi-truck me-1 text-success"></i>
                                <span>ƒê∆°n GHN:</span>
                                <span class="fw-semibold text-success" th:text="${o.ghnOrderCode}">GHN123456</span>
                            </div>
                            <div class="mini-info mb-3" th:if="${o.ghnStatus != null}">
                                <i class="bi bi-box-seam me-1 text-success"></i>
                                <span>Tr·∫°ng th√°i GHN:</span>
                                <span th:text="${o.ghnStatus}">delivering</span>
                            </div>
                            <!-- ‚úÖ K·∫øt th√∫c ph·∫ßn GHN -->

                            <div class="total-line">
                                <div class="text-muted">T·ªïng thanh to√°n:</div>
                                <div class="total-amount">
                                    <span th:text="${#numbers.formatDecimal(o.totalPrice,0,'POINT',0,'COMMA')}">0</span>ƒë
                                </div>
                            </div>
                            <!-- H√†nh ƒë·ªông -->
                            <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
                                <!-- Hu·ª∑ ƒë∆°n (ƒëi tr∆∞·ªõc) -->
                                <form th:if="${o.orderStauts == T(com.example.fruitmarket.enums.OrderStauts).PENDING
                                              or o.ghnStatus   == T(com.example.fruitmarket.enums.GhnStatus).READY_TO_PICK
                                              or o.ghnStatus   == T(com.example.fruitmarket.enums.GhnStatus).PICKING}"
                                      th:action="@{|/orders/${o.id}/cancel|}" method="post"
                                      class="m-0"
                                      th:attr="onsubmit=|return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën hu·ª∑ ƒë∆°n #${o.id}?');|">
                                    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-x-circle"></i> Hu·ª∑ ƒë∆°n h√†ng
                                    </button>
                                </form>

                                <!-- Chi ti·∫øt (ƒëi sau) -->
                                <a class="btn btn-outline-success btn-sm" th:href="@{'/myOrders/' + ${o.id}}">
                                    <i class="bi bi-receipt-cutoff"></i> Chi ti·∫øt
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const buttons = document.querySelectorAll('.filter-btn');
    const cards   = document.querySelectorAll('[data-status]');

    function norm(s) {
        s = (s || '').toUpperCase().trim();
        if (s === 'CANCELLED') s = 'CANCELED'; // ƒë·ªìng b·ªô 2 c√°ch vi·∫øt
        return s;
    }
    const isEqual = (a, b) => norm(a) === norm(b);

    function applyFilter(status){
        const target = norm(status);
        cards.forEach(c => {
            const s = c.getAttribute('data-status');
            const show = target === 'ALL' ? true : isEqual(s, target);
            c.style.display = show ? '' : 'none';
        });
    }

    // G√°n click cho c√°c n√∫t filter
    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilter(btn.getAttribute('data-filter'));
        });
    });

    // üëâ N·∫øu c√≥ ƒë∆°n COMPLETED th√¨ ch·ªçn lu√¥n filter COMPLETED
    let hasCompleted = false;
    cards.forEach(c => {
        if (isEqual(c.getAttribute('data-status'), 'COMPLETED')) {
            hasCompleted = true;
        }
    });

    if (hasCompleted) {
        const btnCompleted = document.querySelector('[data-filter="COMPLETED"]');
        if (btnCompleted) {
            buttons.forEach(b => b.classList.remove('active'));
            btnCompleted.classList.add('active');
            applyFilter('COMPLETED');
        }
    } else {
        // Ng∆∞·ª£c l·∫°i: hi·ªán t·∫•t c·∫£ nh∆∞ c≈©
        applyFilter('ALL');
    }
</script>
</body>
</html>
